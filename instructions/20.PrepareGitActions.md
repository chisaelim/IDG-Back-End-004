# GitHub Actions CI/CD Pipeline Setup Guide
Automated deployment to VPS using GitHub Actions

---

## Overview

This guide explains how to set up a CI/CD pipeline that automatically deploys your application to a VPS (Virtual Private Server) whenever you push code to the `branchName` branch. The pipeline uses GitHub Actions to copy files via SSH and optionally rebuild Docker containers.

---

## Part 1: Prerequisites

Before setting up the pipeline, ensure you have:

1. ✅ A GitHub repository with your code
2. ✅ A VPS with SSH access configured
3. ✅ Docker and Docker Compose installed on VPS
4. ✅ SSH key-based authentication set up

---

## Part 2: Configure GitHub Repository Secrets

### 2.1 Navigate to Repository Settings

1. Go to your GitHub repository
2. Click **Settings** → **Secrets and variables** → **Actions**
3. Click **New repository secret**

### 2.2 Add Required Secrets

Create these three secrets:

| Secret Name | Description | Example Value |
|-------------|-------------|---------------|
| `VPS_HOST` | Your VPS IP address or domain | `123.45.67.89` or `example.cloud` |
| `VPS_USER` | SSH username on VPS | `ubuntu` or `root` |
| `VPS_SSH_KEY` | Private SSH key content | Contents of `~/.ssh/github_actions` |

**Steps to add each secret:**
1. Click **New repository secret**
2. Name: Enter the secret name (e.g., `VPS_HOST`)
3. Value: Paste the corresponding value
4. Click **Add secret**

---

## Part 3: Create GitHub Actions Workflow

Create file: `.github/workflows/deploy.yml`

```yaml
name: CI/CD pipeline

on:
  push:
    branches: [branchName]
  # pull_request:
  #   branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Copy files to VPS via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "."
          target: "~/example.cloud"
          
    #   - name: Deploy Backend and Frontend on VPS via SSH
    #     uses: appleboy/ssh-action@v1.0.3
    #     with:
    #       host: ${{ secrets.VPS_HOST }}
    #       username: ${{ secrets.VPS_USER }}
    #       key: ${{ secrets.VPS_SSH_KEY }}
    #       port: 22
    #       script: |
    #         cd ~/example.cloud
    #         docker compose -f docker-compose.prod.yml down || true
    #         docker compose -f docker-compose.prod.yml up -d --build
    #         cd ~/example.cloud/frontend
    #         docker compose -f docker-compose.prod.yml down || true
    #         docker compose -f docker-compose.prod.yml up -d --build
```

---

## Part 4: Workflow Explanation

### 4.1 Workflow Trigger

```yaml
on:
  push:
    branches: [branchName]
```

**What it does:** Automatically runs the workflow when you push code to the `branchName` branch.

**Why commented out:**
- `pull_request` trigger is commented because we only want deployment on direct pushes, not on PR creation

### 4.2 Job Configuration

```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
```

**What it does:** Creates a deployment job that runs on GitHub's Ubuntu runner (virtual machine).

### 4.3 Step 1: Checkout Code

```yaml
- name: Checkout code
  uses: actions/checkout@v4
```

**What it does:** Downloads your repository code into the GitHub Actions runner.

**Why needed:** The runner needs your code to copy it to the VPS.

### 4.4 Step 2: Copy Files via SCP

```yaml
- name: Copy files to VPS via SSH
  uses: appleboy/scp-action@v0.1.7
  with:
    host: ${{ secrets.VPS_HOST }}
    username: ${{ secrets.VPS_USER }}
    key: ${{ secrets.VPS_SSH_KEY }}
    port: 22
    source: "."
    target: "~/example.cloud"
```

**What it does:** 
- Securely copies all files from the repository to your VPS
- Uses SSH/SCP protocol for secure file transfer
- Target location: `~/example.cloud` directory on VPS

**Parameters explained:**
- `host`: VPS IP or domain from GitHub secrets
- `username`: SSH user from GitHub secrets
- `key`: SSH private key from GitHub secrets
- `port`: SSH port (default 22)
- `source`: "." means all files in repository root
- `target`: Destination directory on VPS

### 4.5 Step 3: Deploy Backend & Frontend via Docker (Currently Commented)

```yaml
# - name: Deploy Backend on VPS via SSH
#   uses: appleboy/ssh-action@v1.0.3
#   with:
#     host: ${{ secrets.VPS_HOST }}
#     username: ${{ secrets.VPS_USER }}
#     key: ${{ secrets.VPS_SSH_KEY }}
#     port: 22
#     script: |
#       cd ~/example.cloud
#       docker compose -f docker-compose.prod.yml down || true
#       docker compose -f docker-compose.prod.yml up -d --build
#       cd ~/example.cloud/frontend
#       docker compose -f docker-compose.prod.yml down || true
#       docker compose -f docker-compose.prod.yml up -d --build
```

**What it does when uncommented:**
1. SSH into the VPS
2. Deploy backend: Navigate to `~/example.cloud`, stop containers, rebuild and restart
3. Deploy frontend: Navigate to `~/example.cloud/frontend`, stop containers, rebuild and restart

**Why commented:**
- Manual control: You might want to test files before restarting containers
- Downtime: Automatic restart might cause brief service interruption
- Safety: Manual deployment gives you more control

**Script breakdown:**
- **Backend deployment:**
  - `cd ~/example.cloud` - Navigate to backend project directory
  - `docker compose -f docker-compose.prod.yml down || true` - Stop backend containers
  - `docker compose -f docker-compose.prod.yml up -d --build` - Rebuild and start backend
- **Frontend deployment:**
  - `cd ~/example.cloud/frontend` - Navigate to frontend directory
  - `docker compose -f docker-compose.prod.yml down || true` - Stop frontend containers
  - `docker compose -f docker-compose.prod.yml up -d --build` - Rebuild and start frontend