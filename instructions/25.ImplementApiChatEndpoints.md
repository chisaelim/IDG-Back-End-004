# Chat API Implementation Summary

## Overview
Complete chat system with personal/group messaging, member management, and message tracking.

## Form Requests

### 1. CreateChatRequest
**File**: `app/Http/Requests/Chat/CreateChatRequest.php`

```php
<?php

namespace App\Http\Requests\Chat;

use Illuminate\Contracts\Validation\Validator;
use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Validation\Rule;

class CreateChatRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'name' => [
                'nullable',
                'string',
                'max:250',
                Rule::requiredIf(fn() => $this->input('type') === 'group')
            ],
            'type' => ['required', 'string', Rule::in(['personal', 'group'])],
            'user_ids' => ['required', 'array', 'min:1', Rule::when($this->input('type') === 'personal', ['max:1'])],
            'user_ids.*' => ['required', 'integer', 'exists:users,id', 'distinct'],
        ];
    }

    public function messages(): array
    {
        return [
            'name.required' => 'Group chat name is required',
            'type.in' => 'Chat type must be either personal or group',
            'user_ids.required' => 'At least one member is required',
            'user_ids.*.exists' => 'One or more selected users do not exist',
        ];
    }

    public function withValidator(Validator $validator)
    {
        $validator->after(function ($validator) {
            if ($this->user()->id === $this->input('user_ids')[0]) {
                $validator->errors()->add('user_ids', 'You cannot create a personal chat with yourself.');
            }
        });
    }
}
```

### 2. UpdateChatRequest
**File**: `app/Http/Requests/Chat/UpdateChatRequest.php`

```php
<?php

namespace App\Http\Requests\Chat;

use Illuminate\Foundation\Http\FormRequest;

class UpdateChatRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'name' => ['required', 'string', 'max:250'],
        ];
    }

    public function messages(): array
    {
        return [
            'name.required' => 'Chat name is required',
            'name.max' => 'Chat name must not exceed 250 characters',
        ];
    }
}
```

### 3. SendMessageRequest
**File**: `app/Http/Requests/ChatMessage/SendMessageRequest.php`

```php
<?php

namespace App\Http\Requests\ChatMessage;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Validation\Rule;

class SendMessageRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'content' => ['required'],
            'type' => ['required', 'string', Rule::in(['text'])],
        ];
    }

    public function messages(): array
    {
        return [
            'content.required' => 'Message content is required for chat messages',
            'type.in' => 'Message type must be text, image, video, or file',
        ];
    }
}
```

### 4. UpdateMessageRequest
**File**: `app/Http/Requests/ChatMessage/UpdateMessageRequest.php`

```php
<?php

namespace App\Http\Requests\ChatMessage;

use Illuminate\Foundation\Http\FormRequest;

class UpdateMessageRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'content' => ['required', 'string'],
        ];
    }

    public function messages(): array
    {
        return [
            'content.required' => 'Message content is required',
        ];
    }
}
```

### 5. AddMemberRequest
**File**: `app/Http/Requests/ChatMember/AddMemberRequest.php`

```php
<?php

namespace App\Http\Requests\ChatMember;

use Illuminate\Foundation\Http\FormRequest;

class AddMemberRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'user_id' => ['required', 'integer', 'exists:users,id'],
        ];
    }

    public function messages(): array
    {
        return [
            'user_id.required' => 'User ID is required',
            'user_id.exists' => 'Selected user does not exist',
        ];
    }
}
```

### 6. UpdateMemberRoleRequest
**File**: `app/Http/Requests/ChatMember/UpdateMemberRoleRequest.php`

```php
<?php

namespace App\Http\Requests\ChatMember;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Validation\Rule;

class UpdateMemberRoleRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'role' => ['required', 'string', Rule::in(['admin', 'member'])],
        ];
    }

    public function messages(): array
    {
        return [
            'role.required' => 'Role is required',
            'role.in' => 'Role must be either admin or member',
        ];
    }
}
```

## Resources

### 1. ChatResource
**File**: `app/Http/Resources/ChatResource.php`

```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class ChatResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'name' => $this->name,
            'type' => $this->type,
            'created_at' => $this->created_at,
            'updated_at' => $this->updated_at,
            'last_message' => $this->whenLoaded('messages', function () {
                return $this->messages->isNotEmpty() ? new ChatMessageResource($this->messages->first()) : null;
            }),
            'unread_count' => $this->when(isset($this->unread_count), $this->unread_count ?? 0),
        ];
    }
}
```

### 2. ChatMessageResource
**File**: `app/Http/Resources/ChatMessageResource.php`

```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class ChatMessageResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'content' => $this->content,
            'type' => $this->type,
            'chat_id' => $this->chat_id,
            'user_id' => $this->user_id,
            'seen_at' => $this->seen_at,
            'created_at' => $this->created_at,
            'updated_at' => $this->updated_at,
            'user' => $this->whenLoaded('user', function () {
                return [
                    'id' => $this->user->id,
                    'name' => $this->user->name,
                    'email' => $this->user->email,
                ];
            }),
            'own_message' => $this->user_id === $request->user()->id,
        ];
    }
}
```

### 3. ChatMemberResource
**File**: `app/Http/Resources/ChatMemberResource.php`

```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class ChatMemberResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'role' => $this->role,
            'chat_id' => $this->chat_id,
            'user_id' => $this->user_id,
            'joined_at' => $this->created_at,
            'user' => $this->whenLoaded('user', function () {
                return [
                    'id' => $this->user->id,
                    'name' => $this->user->name,
                    'email' => $this->user->email,
                ];
            }),
        ];
    }
}
```

## Controllers

### 1. ChatController
**File**: `app/Http/Controllers/Api/ChatController.php`

Key methods:
- `getChats()` - List all user's chats with pagination
- `createChat()` - Create personal/group chat
- `readChat()` - Get single chat details
- `updateGroupChat()` - Update group chat name (admin only)
- `deleteGroupChat()` - Delete group chat (admin only)
- `leaveGroupChat()` - Leave group chat

### 2. ChatMessageController
**File**: `app/Http/Controllers/Api/ChatMessageController.php`

Key methods:
- `getMessages()` - Get chat messages with pagination
- `createMessage()` - Send new message
- `updateMessage()` - Edit text message
- `deleteMessage()` - Delete own message
- `markMessageAsSeen()` - Mark message as seen
- `markAllMessagesAsSeen()` - Mark all messages in chat as seen

### 3. ChatMemberController
**File**: `app/Http/Controllers/Api/ChatMemberController.php`

Key methods:
- `getMembers()` - Get chat members
- `addMember()` - Add member to group (admin only)
- `updateMember()` - Update member role (admin only)
- `removeMember()` - Remove member (admin only)

## API Routes
**File**: `routes/api.php`

Add to the file:

```php
use App\Http\Controllers\API\ChatController;
use App\Http\Controllers\API\ChatMessageController;
use App\Http\Controllers\API\ChatMemberController;

Route::middleware('auth:sanctum')->group(function () {
    // Chat API Routes
    Route::prefix('chats')->group(function () {
        // Chat management
        Route::get('/', [ChatController::class, 'getChats']);
        Route::post('/create', [ChatController::class, 'createChat']);
        Route::get('/read/{chatId}', [ChatController::class, 'readChat']);
        Route::patch('update/{chatId}', [ChatController::class, 'updateGroupChat']);
        Route::delete('delete/{chatId}', [ChatController::class, 'deleteGroupChat']);
        Route::post('leave/{chatId}', [ChatController::class, 'leaveGroupChat']);

        // Chat messages
        Route::get('/{chatId}/messages', [ChatMessageController::class, 'getMessages']);
        Route::post('/{chatId}/messages/create', [ChatMessageController::class, 'createMessage']);
        Route::patch('/{chatId}/messages/update/{messageId}', [ChatMessageController::class, 'updateMessage']);
        Route::delete('/{chatId}/messages/delete/{messageId}', [ChatMessageController::class, 'deleteMessage']);
        Route::post('/{chatId}/messages/seen/{messageId}', [ChatMessageController::class, 'markMessageAsSeen']);
        Route::post('/{chatId}/messages/seen-all', [ChatMessageController::class, 'markAllMessagesAsSeen']);

        // Chat members
        Route::get('/{chatId}/members', [ChatMemberController::class, 'getMembers']);
        Route::post('/{chatId}/members/add', [ChatMemberController::class, 'addMember']);
        Route::patch('/{chatId}/members/update/{memberId}', [ChatMemberController::class, 'updateMember']);
        Route::delete('/{chatId}/members/remove/{memberId}', [ChatMemberController::class, 'removeMember']);
    });
});
```

## API Endpoints

### Chat Management
- `GET /api/chats` - List all user chats
- `POST /api/chats/create` - Create new chat
- `GET /api/chats/read/{chatId}` - Get chat details
- `PATCH /api/chats/update/{chatId}` - Update group chat
- `DELETE /api/chats/delete/{chatId}` - Delete group chat
- `POST /api/chats/leave/{chatId}` - Leave group chat

### Chat Messages
- `GET /api/chats/{chatId}/messages` - Get messages
- `POST /api/chats/{chatId}/messages/create` - Send message
- `PATCH /api/chats/{chatId}/messages/update/{messageId}` - Update message
- `DELETE /api/chats/{chatId}/messages/delete/{messageId}` - Delete message
- `POST /api/chats/{chatId}/messages/seen/{messageId}` - Mark as seen
- `POST /api/chats/{chatId}/messages/seen-all` - Mark all as seen

### Chat Members
- `GET /api/chats/{chatId}/members` - Get members
- `POST /api/chats/{chatId}/members/add` - Add member
- `PATCH /api/chats/{chatId}/members/update/{memberId}` - Update role
- `DELETE /api/chats/{chatId}/members/remove/{memberId}` - Remove member

## Testing Commands

### Create Chat
```bash
curl -X POST http://localhost/api/chats/create \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "personal",
    "user_ids": [2]
  }'
```

### Send Message
```bash
curl -X POST http://localhost/api/chats/1/messages/create \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "content": "Hello!",
    "type": "text"
  }'
```

### Get Chats
```bash
curl -X GET "http://localhost/api/chats?per_page=15" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## Summary

### Files Created
1. 3 Migration files
2. 3 Model files (Chat, ChatMessage, ChatMember)
3. 6 Request validation files
4. 3 Resource files
5. 3 Controller files
6. Updated routes/api.php

### Features Implemented
- Personal and group chat support
- Message CRUD operations
- Member management (add/remove/update roles)
- Message seen/unread tracking
- Admin role management
- Pagination support
- Authorization checks
- Relationship queries optimization

### Key Features
- Personal chats prevent duplicates
- Admin auto-assignment on chat creation
- Group chat admin role transfer on leave
- Auto-cleanup when last member leaves
- Unread message counting
- Optimized queries with eager loading
