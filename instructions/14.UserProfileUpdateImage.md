# User Profile Image Update Feature

This guide provides step-by-step instructions for implementing a user profile photo update feature, from backend to frontend.

## Overview
This feature allows users to upload, update, and delete their profile photos. The implementation includes:
- Image upload and processing using Intervention Image
- Base64 image validation
- Database migration for photo storage
- API endpoint for photo updates
- Frontend UI for photo management

---

## Backend Implementation

### 1. Install Required Packages

Install the necessary Laravel packages for image handling and validation.

```bash
composer require intervention/image:^3.11
composer require crazybooot/base64-validation:^1.0
```

**Updated composer.json:**
```json
{
    "require": {
        "php": "^8.2",
        "crazybooot/base64-validation": "^1.0",
        "intervention/image": "^3.11",
        "laravel/framework": "^12.0",
        "laravel/sanctum": "^4.2",
        "laravel/socialite": "^5.24"
    }
}
```

### 2. Create Database Migration

Create a migration to add the photo column to the users table:

```bash
php artisan make:migration add_photo_column_to_users_table
```

**Migration file: `database/migrations/2026_01_14_162538_add_photo_column_to_users_table.php`**

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('photo')->nullable()->after('password');
        });
    }

    public function down(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('photo');
        });
    }
};
```

Run the migration:
```bash
php artisan migrate
```

### 3. Create Upload Trait

Create a reusable trait for image upload handling.

**File: `app/Traits/UploadMethod.php`**

```php
<?php

namespace App\Traits;

use Exception;
use Throwable;
use Illuminate\Support\Facades\File;
use Intervention\Image\ImageManager;
use Illuminate\Support\Facades\Storage;
use Intervention\Image\Drivers\Gd\Driver;
use Intervention\Image\Decoders\Base64ImageDecoder;
use Intervention\Image\Decoders\DataUriImageDecoder;

trait UploadMethod
{
    public static function storeImage($image, $folder_name)
    {
        try {
            $image_name = 'IMG-' . uniqid() . '.png';
            $manager = new ImageManager(new Driver());
            $processedImage = $manager->read($image, [
                DataUriImageDecoder::class,
                Base64ImageDecoder::class,
            ]);

            $encoded = $processedImage->toPng();
            // Save image to storage/app/public/{folder_name}
            Storage::disk('public')->put(
                "$folder_name/$image_name",
                $encoded
            );

            return $image_name;
        } catch (Exception $e) {
            throw $e;
        } catch (Throwable $th) {
            throw $th;
        }
    }

    public static function discardImage($image_name, $folder_name)
    {
        try {
            // Delete from storage/app/public/{folder_name}
            if (Storage::disk('public')->exists("$folder_name/$image_name")) {
                Storage::disk('public')->delete("$folder_name/$image_name");
            }
            return true;
        } catch (Exception $e) {
            throw $e;
        } catch (Throwable $th) {
            throw $th;
        }
    }
}
```

### 4. Update User Model

Add the photo attribute and mutator to the User model.

**File: `app/Models/User.php`**

Add the following changes:

1. Import the Attribute class:
```php
use Illuminate\Database\Eloquent\Casts\Attribute;
```

2. Add 'photo' to the fillable array:
```php
protected $fillable = [
    'name',
    'email',
    'password',
    'email_verified_at',
    'photo'
];
```

3. Add the Photo accessor:
```php
protected function Photo(): Attribute
{
    return Attribute::make(
        get: fn(string|null $value) => $value ?
            asset('storage/profile/' . $value) :
            null,
    );
}
```

**Note:** The accessor converts the stored filename to a full URL accessible from the frontend.

### 5. Update Controller

Add the photo update functionality to the AuthController.

**File: `app/Http/Controllers/API/AuthController.php`**

1. Import the UploadMethod trait:
```php
use App\Traits\UploadMethod;
```

2. Use the trait in the controller:
```php
class AuthController extends Controller
{
    use UploadMethod;
    // ... existing code
}
```

3. Add the updateUserPhoto method:
```php
function updateUserPhoto(Request $request)
{
    $request->validate([
        'photo' => 'nullable|base64image|base64mimes:png,jpg,jpeg|base64dimensions:width=454,height=454'
    ]);

    $user = $request->user();

    try {
        DB::beginTransaction();
        UploadMethod::discardImage($user->getRawOriginal('photo'), 'profile');
        $user->photo = null;
        if (!empty($request->photo)) {
            $user->photo = UploadMethod::storeImage($request->photo, 'profile');
        }
        $user->save();
        DB::commit();
    } catch (\Exception $e) {
        DB::rollBack();
        throw new \Exception($e->getMessage());
    }

    return response([
        'message' => 'User photo updated successfully.',
        'photo' => $user->photo
    ], 200);
}
```

**Key Points:**
- Validates base64 image with specific dimensions (454x454)
- Deletes old photo before uploading new one
- Uses database transaction for data integrity
- Returns the updated photo URL

### 6. Add API Route

Add the route for updating user photo.

**File: `routes/api.php`**

Add this route inside the authenticated middleware group:

```php
Route::middleware(['auth:sanctum'])->group(function () {
    // ... existing routes
    Route::patch('/update/photo', [AuthController::class, 'updateUserPhoto']);
});
```

### 7. Create Storage Link

Create a symbolic link from public/storage to storage/app/public:

```bash
php artisan storage:link
```

This allows the uploaded images to be accessible from the web.

---

## Frontend Implementation

### 1. Update Vite Configuration

Add an alias for assets folder.

**File: `frontend/vite.config.js`**

```javascript
export default defineConfig({
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url)),
      '@com': fileURLToPath(new URL('./src/components', import.meta.url)),
      '@func': fileURLToPath(new URL('./src/functions', import.meta.url)),
      '@assets': fileURLToPath(new URL('./src/assets', import.meta.url)),
    },
  },
  // ... rest of config
});
```

### 2. Add Default Empty Photo Image

Create an assets folder and add a default empty photo image:

**File: `frontend/src/assets/images/emptyPhoto.png`**

Place a placeholder image for users without photos.

### 3. Create API Function

Add the API function for updating user photo.

**File: `frontend/src/functions/api/auth.js`**

```javascript
export async function patchUpdateUserPhoto(photoData) {
    return await axios.patch(window.API_URL + '/update/photo', photoData);
}
```

### 4. Update Vuex Store

Add a mutation to update user photo in the store.

**File: `frontend/src/main.js`**

Add this mutation to the Vuex store:

```javascript
const store = createStore({
    state: {
        user: null,
    },
    mutations: {
        setUser(state, user) {
            state.user = user;
        },
        setUserPhoto(state, photo) {
            if (state.user) {
                state.user.photo = photo;
            }
        },
    },
    // ... rest of store
});
```

### 5. Update UserProfile Component

Implement the complete photo management UI.

**File: `frontend/src/components/auth/UserProfile.vue`**

**Template Section - Update the profile image area:**

```vue

<div class="text-center">
  <img
    class="profile-user-img img-fluid img-circle"
    :src="tempPhoto"
    alt="User profile picture"
  />
  <input
    @change="onUpdatePhoto($event)"
    type="file"
    class="d-none"
    :accept="allowedExtensions.map((ext) => '.' + ext).join(', ')"
    id="file-input"
  />
  <div class="mt-1">
    <!-- Upload Button -->
    <label :for="'file-input'">
      <a type="button" class="m-1 btn btn-primary btn-sm">
        <i class="fas fa-upload"></i>
      </a>
    </label>
    <!-- Delete Button -->
    <a
      type="button"
      @click="onDeletePhoto()"
      class="m-1 btn btn-danger btn-sm">
      <i class="fas fa-trash"></i>
    </a>
    <!-- Reset Button -->
    <a
      type="button"
      @click="onResetPhoto()"
      class="m-1 btn btn-secondary btn-sm">
      <i class="fas fa-undo-alt"></i>
    </a>
    <!-- Save Button (shows only when photo is changed) -->
    <a
      v-if="changedPhoto"
      type="button"
      @click="updatePhoto()"
      class="m-1 btn btn-success btn-sm">
      <i class="fas fa-check"></i>
    </a>
  </div>
</div>

```

**Script Section - Add the following:**

```vue
<script setup>
import emptyPhoto from "@assets/images/emptyPhoto.png";
import { CloseModal, LoadingModal, MessageModal } from "@func/swal";
import { useRouter } from "vue-router";
import { computed, reactive, ref, watch } from "vue";
import {
  patchChangePassword,
  patchCreatePassword,
  patchUpdateUserPhoto,
} from "@func/api/auth";
import { useStore } from "vuex";

const store = useStore();
const userData = computed(() => store.state.user);
const userPhoto = computed(() => store.state.user.photo);

// ... existing code for password management

// Photo Management
const tempPhoto = ref(null);
watch(
  () => userPhoto.value,
  (nv) => {
    if (nv === null) {
      return (tempPhoto.value = emptyPhoto);
    }
    return (tempPhoto.value = nv);
  },
  { immediate: true }
);

const changedPhoto = computed(
  () =>
    (tempPhoto.value !== emptyPhoto && tempPhoto.value !== userPhoto.value) ||
    (tempPhoto.value === emptyPhoto && userPhoto.value !== null)
);

const allowedExtensions = ["jpg", "jpeg", "png"];

function onUpdatePhoto(event) {
  const files = event.target.files;
  if (files && files.length > 0) {
    const fileName = files[0].name;
    const idxDot = fileName.lastIndexOf(".") + 1;
    const extFile = fileName.substr(idxDot, fileName.length).toLowerCase();
    
    if (!allowedExtensions.includes(extFile)) {
      return MessageModal("error", "Error", "Only jpg/jpeg and png files are allowed!");
    }
    
    const reader = new FileReader();
    reader.onloadend = function () {
      const img = new Image();
      img.onload = function () {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        // Set canvas size to 454x454
        canvas.width = 454;
        canvas.height = 454;

        // Calculate crop dimensions (center crop)
        const size = Math.min(img.width, img.height);
        const x = (img.width - size) / 2;
        const y = (img.height - size) / 2;

        // Draw image cropped and resized to 454x454
        ctx.drawImage(img, x, y, size, size, 0, 0, 454, 454);

        // Convert canvas to base64
        tempPhoto.value = canvas.toDataURL("image/png");
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(files[0]);
    event.target.value = null;
  }
}

function onDeletePhoto() {
  tempPhoto.value = emptyPhoto;
}

function onResetPhoto() {
  tempPhoto.value = userPhoto.value ? userPhoto.value : emptyPhoto;
}

async function updatePhoto() {
  try {
    LoadingModal();
    if (tempPhoto.value === emptyPhoto) {
      tempPhoto.value = null;
    }
    const response = await patchUpdateUserPhoto({ photo: tempPhoto.value });
    store.commit("setUserPhoto", response.data.photo);
    await MessageModal("success", "Success", response.data.message);
  } catch (error) {
    return MessageModal("error", "Error", error.response?.data?.message || error.message);
  }
}
</script>
```

---

## Key Features Explained

### Backend Features:

1. **Image Processing**: 
   - Uses Intervention Image library to process and convert images to PNG format
   - Generates unique filenames for each upload

2. **Validation**: 
   - Validates base64 encoded images
   - Enforces specific dimensions (454x454)
   - Accepts only jpg, jpeg, and png formats

3. **Storage Management**:
   - Deletes old photos before uploading new ones
   - Stores images in `storage/app/public/profile/`
   - Accessible via `public/storage/profile/` after running `storage:link`

4. **Model Accessor**:
   - Automatically converts stored filename to full URL
   - Returns null if no photo exists

### Frontend Features:

1. **Image Upload**:
   - File input with extension validation
   - Client-side image resizing to 454x454
   - Center-crop functionality for non-square images

2. **Preview Management**:
   - Shows temporary preview before saving
   - Reset button to revert changes
   - Delete button to remove photo

3. **State Management**:
   - Vuex store tracks user photo
   - Reactive updates across components
   - Watcher syncs photo with user state

4. **User Experience**:
   - Upload, delete, reset, and save buttons
   - Save button appears only when changes are detected
   - Loading modal during upload
   - Success/error messages

---

## Testing the Feature

### Backend Testing:

1. Test with Postman or similar tool:
```
PATCH /api/update/photo
Headers: Authorization: Bearer {token}
Body: {
  "photo": "data:image/png;base64,iVBORw0KG..."
}
```

2. Verify image is saved in `storage/app/public/profile/`
3. Check database for filename in users table
4. Verify URL returned in response

### Frontend Testing:

1. Navigate to user profile page
2. Click upload button and select an image
3. Verify preview shows cropped/resized image
4. Click save button
5. Verify photo updates in UI
6. Test delete and reset functionality
7. Refresh page to verify persistence

---

## Troubleshooting

### Common Issues:

1. **Images not accessible**:
   - Run `php artisan storage:link`
   - Check folder permissions

2. **Upload fails**:
   - Verify composer packages are installed
   - Check file size limits in php.ini
   - Verify validation rules match frontend

3. **Image quality issues**:
   - Adjust canvas dimensions in frontend
   - Modify image encoding settings

4. **CORS errors**:
   - Ensure API URL is correctly configured
   - Check Laravel CORS settings

---

## Summary

This implementation provides a complete user profile photo management system with:
- ✅ Backend image processing and storage
- ✅ Database integration
- ✅ Validation and security
- ✅ Frontend UI with upload, delete, and preview
- ✅ State management
- ✅ Responsive user experience

The feature is production-ready and follows Laravel and Vue.js best practices.