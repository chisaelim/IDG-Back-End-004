# Chat Frontend Implementation - Part 1

This document contains all the changed files with their complete code for the Chat Frontend implementation.

## Install Front End Library

```sh
npm install dayjs
```

## Changed Files Summary

1. `frontend/index.html` - Updated body class
2. `frontend/package.json` - Added dayjs dependency
3. `frontend/package-lock.json` - Updated with dayjs and jquery-validation
4. `frontend/src/components/includes/Sidebar.vue` - Complete sidebar overhaul with chat search
5. `frontend/src/main.css` - Added chat-specific CSS styles
6. `frontend/src/main.js` - Reordered imports
7. `frontend/src/router/index.js` - Added ChatBox route
8. `frontend/src/components/includes/controls/ChatOption.vue` - **NEW FILE**
9. `frontend/src/components/includes/controls/UserOption.vue` - **NEW FILE**
10. `frontend/src/components/pages/ChatBox.vue` - **NEW FILE**
11. `frontend/src/functions/api/chat.js` - **NEW FILE**
12. `frontend/src/functions/api/chat_member.js` - **NEW FILE**
13. `frontend/src/functions/api/chat_message.js` - **NEW FILE**
14. `frontend/src/functions/api/user.js` - **NEW FILE**
15. `frontend/src/functions/datetime.js` - **NEW FILE**

---

## 1. frontend/index.html

```html
<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vite App</title>
  <link rel="stylesheet" href="/src/main.css">
</head>

<body class="layout-fixed" style="height: auto;">
  <div id="app" class="wrapper">

  </div>
  <script type="module" src="/src/main.js"></script>
</body>

</html>
```

---

## 2. frontend/package.json

```json
{
  "name": "temp_folder",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "engines": {
    "node": "^20.19.0 || >=22.12.0"
  },
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "test:unit": "vitest",
    "lint": "eslint . --fix --cache",
    "format": "prettier --write --experimental-cli src/"
  },
  "dependencies": {
    "admin-lte": "^3.2.0",
    "axios": "^1.13.2",
    "dayjs": "^1.11.19",
    "sweetalert2": "^11.26.17",
    "vue": "^3.5.26",
    "vue-router": "^4.6.4",
    "vuex": "^4.1.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.2",
    "@vitejs/plugin-vue": "^6.0.3",
    "@vitest/eslint-plugin": "^1.6.4",
    "@vue/eslint-config-prettier": "^10.2.0",
    "@vue/test-utils": "^2.4.6",
    "eslint": "^9.39.2",
    "eslint-plugin-vue": "~10.6.2",
    "globals": "^16.5.0",
    "jsdom": "^27.3.0",
    "prettier": "3.7.4",
    "vite": "^7.3.0",
    "vite-plugin-vue-devtools": "^8.0.5",
    "vitest": "^4.0.16"
  }
}
```

---

## 3. frontend/src/components/includes/Sidebar.vue

```vue
<template>
  <aside class="main-sidebar sidebar-light-primary elevation-4" style="height: auto">
    <router-link :to="{ name: 'dashboard' }" class="brand-link">
      <img
        :src="logoImg"
        alt="AdminLTE Logo"
        class="brand-image img-circle elevation-3"
        style="opacity: 0.8"
      />
      <span class="brand-text font-weight-light">AdminLTE 3</span>
    </router-link>

    <div class="sidebar">
      <router-link :to="{ name: 'profile' }">
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          <div class="image">
            <img
              :src="userData.photo || emptyPhoto"
              class="img-circle elevation-2"
              alt="User Image"
            />
          </div>
          <div class="info">
            <a href="#" class="d-block">{{ userData.name }}</a>
          </div>
        </div>
      </router-link>
      <nav class="mt-2">
        <ul
          class="nav nav-pills nav-sidebar flex-column"
          data-widget="treeview"
          role="menu"
          data-accordion="false"
        >
          <li class="nav-item">
            <router-link
              :to="{ name: 'dashboard' }"
              class="nav-link"
              active-class="active"
            >
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>Dashboard</p>
            </router-link>
          </li>
          <li v-if="isAdmin" class="nav-header">Systems</li>
          <li v-if="isAdmin" class="nav-item">
            <router-link :to="{ name: 'backups' }" class="nav-link" active-class="active">
              <i class="nav-icon fas fa-database"></i>
              <p>Backup</p>
            </router-link>
          </li>
        </ul>
      </nav>
      <hr />

      <div class="form-inline">
        <div class="input-group" data-widget="sidebar-search">
          <input
            v-model="searchQuery"
            class="form-control form-control-sidebar"
            type="search"
            placeholder="Search"
            aria-label="Search"
          />
          <div class="input-group-append">
            <button @click="clearSearchQuery" type="button" class="btn btn-sidebar">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
      </div>

      <nav class="mt-2">
        <ul
          v-if="searchQuery"
          class="nav nav-pills nav-sidebar flex-column"
          data-widget="treeview"
          role="menu"
          data-accordion="false"
        >
          <li class="nav-header">Search Results</li>
          <li
            @click="clearSearchQuery"
            class="nav-item"
            v-for="user in filteredUsers"
            :key="user.id"
          >
            <UserOption :user="user" />
          </li>
          <li
            @click="clearSearchQuery"
            class="nav-item"
            v-for="chat in sortedFilteredChats"
            :key="chat.id"
          >
            <ChatOption :chat="chat" />
          </li>
        </ul>
        <ul
          v-else
          class="nav nav-pills nav-sidebar flex-column"
          data-widget="treeview"
          role="menu"
          data-accordion="false"
        >
          <li class="nav-header">Recent Chats</li>
          <li
            @click="clearSearchQuery"
            class="nav-item"
            v-for="chat in sortedRecentChats"
            :key="chat.id"
          >
            <ChatOption :chat="chat" />
          </li>
        </ul>
      </nav>
    </div>
  </aside>
</template>
<script setup>
import emptyPhoto from "@assets/images/emptyPhoto.png";
import logoImg from "admin-lte/dist/img/AdminLTELogo.png";
import { useStore } from "vuex";
import { useRoute } from "vue-router";
import { computed, onMounted, ref, watch } from "vue";
import { LoadingModal, MessageModal, CloseModal } from "@func/swal";
import { apiGetChats, apiGetChatFile } from "@func/api/chat";
import { apiGetUsers } from "@func/api/user";

import ChatOption from "@com/includes/controls/ChatOption.vue";
import UserOption from "@com/includes/controls/UserOption.vue";
const store = useStore();
const userData = computed(() => store.state.user);
const isAdmin = computed(() => userData.value && userData.value.level === "admin");

const route = useRoute();
let searchTimeout = null;
const searchQuery = ref("");
const filteredChats = ref([]);
const filteredUsers = ref([]);
const recentChats = ref([]);

const sortedRecentChats = computed(() => {
  return [...recentChats.value].sort((a, b) => {
    const timeA = a.last_message?.created_at;
    const timeB = b.last_message?.created_at;
    return new Date(timeB) - new Date(timeA); // Descending order (newest first)
  });
});

const sortedFilteredChats = computed(() => {
  return [...filteredChats.value].sort((a, b) => {
    const timeA = a.last_message?.created_at;
    const timeB = b.last_message?.created_at;
    return new Date(timeB) - new Date(timeA);
  });
});

onMounted(async () => {
  try {
    LoadingModal();
    const response = await apiGetChats();
    recentChats.value = response.data.chats;
    await processChatImages(recentChats.value);
    CloseModal();
  } catch (error) {
    return MessageModal("error", "Error", error.response?.data?.message || error.message);
  }
});
watch(searchQuery, async (newQuery) => {
  // Clear the previous timeout
  if (searchTimeout) {
    clearTimeout(searchTimeout);
  }

  if (newQuery.trim() === "") {
    filteredChats.value = [];
    filteredUsers.value = [];
    return;
  }

  // Set a new timeout for 1 second
  searchTimeout = setTimeout(async () => {
    try {
      const response = await Promise.all([
        apiGetChats({ search: newQuery }),
        apiGetUsers({ search: newQuery }),
      ]);
      filteredChats.value = response[0].data.chats;
      filteredUsers.value = response[1].data.users;

      await processChatImages(filteredChats.value);
    } catch (error) {
      return MessageModal(
        "error",
        "Error",
        error.response?.data?.message || error.message
      );
    }
  }, 1000);
});

async function processChatImages(chats) {
  await Promise.all(
    chats.map(async (chat) => {
      if (!chat.photo) {
        chat.photo = emptyPhoto;
        return;
      }
      if (chat.type === "group") {
        chat.photo = await loadChatImage(chat.photo);
        return;
      }
    })
  );
}
async function loadChatImage(uri) {
  try {
    const response = await apiGetChatFile(uri);
    return URL.createObjectURL(response.data);
  } catch (error) {
    return emptyPhoto;
  }
}
function clearSearchQuery() {
  searchQuery.value = "";
}
</script>
```

---

## 4. frontend/src/main.css

```css
@import url('https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback');
@import 'admin-lte/plugins/fontawesome-free/css/all.min.css';
@import 'admin-lte/plugins/icheck-bootstrap/icheck-bootstrap.min.css';
@import 'admin-lte/dist/css/adminlte.min.css';

.nav-item p.chat-name {
    position: absolute;
    left: 55px;
    top: 13px;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 125px;
    /* or any specific width/max-width */
    display: inline-block;
    /* or inline-block */
}

.nav-item p.chat-datetime {
    font-size: 0.75rem;
    position: absolute;
    right: 5px;
    top: 2px;
}

.nav-item p.chat-message {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 185px;
    /* or any specific width/max-width */
    display: inline-block;
    /* or inline-block */
}

.nav-item p.chat-activity-icon {
    font-size: 1rem;
    position: absolute;
    right: 10px;
    bottom: 10px;
    animation: blinker 1.5s linear infinite;
}

@keyframes blinker {
    0% {
        opacity: 1;
        /* Fully visible */
    }

    50% {
        opacity: 0;
        /* Hidden */
    }

    100% {
        opacity: 1;
        /* Fully visible, optional if infinite is used */
    }
}
```

---

## 5. frontend/src/main.js

```javascript
import 'admin-lte/dist/js/adminlte.min.js';
import 'admin-lte/plugins/bootstrap/js/bootstrap.bundle.min.js';

import Swal from 'sweetalert2';
window.Swal = Swal;

import axios from 'axios';
window.axios = axios;

window.API_URL = import.meta.env.VITE_API_URL;

import { createApp } from 'vue';
import { createStore } from 'vuex';
import App from './App.vue';
import router from './router';
import { getVerifyAccount } from '@func/api/auth';
const app = createApp(App);

const store = createStore({
    state: {
        user: null,
    },
    mutations: {
        setUser(state, user) {
            state.user = user;
        },
        setUserPhoto(state, photo) {
            if (state.user) {
                state.user.photo = photo;
            }
        },
    },
    actions: {
        async verifyAccount({ commit }) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    localStorage.removeItem('token');
                    return commit('setUser', null);
                }
                axios.defaults.headers.common['Authorization'] = token ? `Bearer ${token}` : '';
                const response = await getVerifyAccount(token);
                return commit('setUser', response.data.user);
            } catch (error) {
                localStorage.removeItem('token');
                commit('setUser', null);
            }
        }
    }
});


app.use(router);
app.use(store);
app.mount('#app');


router.beforeEach(async (to, from, next) => {
    await store.dispatch('verifyAccount');
    const guard = Boolean(to.meta.guard);
    const isAuthenticated = Boolean(store.state.user !== null);
    if (!guard && isAuthenticated) {
        return next({ name: 'dashboard' })
    }
    if (guard && !isAuthenticated) {
        return next({ name: 'auth.signin' });
    }
    return next();
});
```

---

## 6. frontend/src/router/index.js

```javascript
import Signin from '@com/auth/Signin.vue';
import Signout from '@com/auth/Signout.vue';
import Signup from '@com/auth/Signup.vue';
import VerifyEmail from '@com/auth/VerifyEmail.vue';
import ResetPassword from '@com/auth/ResetPassword.vue';
import SetNewPassword from '@com/auth/SetNewPassword.vue';
import GoogleCallback from '@com/auth/GoogleCallback.vue';
import GoogleCallbackError from '@com/auth/GoogleCallbackError.vue';
import UserProfile from '@com/auth/UserProfile.vue';
import Dashboard from '@com/pages/Dashboard.vue';
import Backup from '@com/pages/Backup.vue';

import { createRouter, createWebHistory } from 'vue-router'
import Navbar from '@com/includes/Navbar.vue';
import Footer from '@com/includes/Footer.vue';
import Sidebar from '@com/includes/Sidebar.vue';

import ChatBox from '@com/pages/ChatBox.vue';

import { useStore } from 'vuex';
function authorize(roles) {
  return (to, from, next) => {
    const store = useStore();
    const user = store.state.user;
    if (user && roles.includes(user.level)) {
      return next();
    }
    return next({ name: 'dashboard' });
  }
}

const includes = {
  navbar: Navbar,
  sidebar: Sidebar,
  footer: Footer,
}
const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [
    {
      path: '/',
      name: 'auth.signin',
      component: Signin,
      meta: { guard: false },
    },
    {
      path: '/signout',
      name: 'auth.signout',
      component: Signout,
      meta: { guard: true },
    },
    {
      path: '/signup',
      name: 'auth.signup',
      component: Signup,
      meta: { guard: false },
    },
    {
      path: '/email/verify/:api_url',
      name: 'auth.verify.email',
      component: VerifyEmail,
      meta: { guard: false },
    },
    {
      path: '/password/reset',
      name: 'auth.reset.password',
      component: ResetPassword,
      meta: { guard: false },
    },
    {
      path: '/password/reset/:api_url',
      name: 'auth.set.password',
      component: SetNewPassword,
      meta: { guard: false },
    },
    {
      path: '/auth/google/callback',
      name: 'auth.google.callback',
      component: GoogleCallback,
      meta: { guard: false },
    },
    {
      path: '/auth/google/callback/error',
      name: 'auth.google.callback.error',
      component: GoogleCallbackError,
      meta: { guard: false },
    },
    {
      path: '/dashboard',
      name: 'dashboard',
      components: {
        default: Dashboard,
        ...includes,
      },
      meta: { guard: true },
    },
    {
      path: '/profile',
      name: 'profile',
      components: {
        default: UserProfile,
        ...includes,
      },
      meta: { guard: true },
    },
    {
      path: '/backups',
      name: 'backups',
      components: {
        default: Backup,
        ...includes,
      },
      meta: { guard: true },
      beforeEnter: authorize(['admin'])
    },
    {
      path: '/chats/:chatId',
      name: 'chats',
      components: {
        default: ChatBox,
        ...includes,
      },
      meta: { guard: true },
    },
  ],
})

export default router
```

---

## 7. frontend/src/components/includes/controls/ChatOption.vue (NEW FILE)

```vue
<template>
  <router-link
    :to="{ name: 'chats', params: { chatId: chat.id } }"
    class="nav-link"
    active-class="active"
  >
    <img class="nav-icon img-circle elevation-3 my-1" :src="chat.photo" />
    <p class="chat-name">{{ chat.name }}</p>
    <p class="chat-datetime">
      {{ chat.last_message ? formatChatTime(chat.last_message.created_at) : "" }}
    </p>
    <br />
    <p class="chat-message">
      <span v-if="chat.last_message?.user?.id === userData.id" class="text-bold"
        >You:
      </span>
      {{ chat.last_message ? chat.last_message.content : "Start a new conversation" }}
    </p>
    <p class="chat-activity-icon">
      <i class="far fa-paper-plane"></i>
      <!-- <i class="far fa-comment-dots"></i>
      <i class="fas fa-microphone"></i> -->
    </p>
  </router-link>
</template>
<script setup>
import { formatChatTime } from "@func/datetime";
import { computed } from "vue";
import { useStore } from "vuex";
const store = useStore();
const userData = computed(() => store.state.user);
const props = defineProps({
  chat: {
    type: Object,
    required: true,
  },
});
</script>
```

---

## 8. frontend/src/components/includes/controls/UserOption.vue (NEW FILE)

```vue
<template>
  <a @click="createPersonalChat" class="nav-link" role="button">
    <img class="nav-icon img-circle elevation-3 my-1" :src="user.photo || emptyPhoto" />
    <p class="chat-name">{{ user.name }}</p>
    <br />
    <p class="chat-message">{{ user.email }}</p>
  </a>
</template>

<script setup>
import emptyPhoto from "@assets/images/emptyPhoto.png";
import { apiCreateChat } from "@func/api/chat";
import { useRouter } from "vue-router";
import { MessageModal } from "@func/swal";

const router = useRouter();

const props = defineProps({
  user: {
    type: Object,
    required: true,
  },
});

async function createPersonalChat() {
  try {
    const response = await apiCreateChat({
      type: "personal",
      user_ids: [props.user.id],
    });
    router.push({ name: "chats", params: { chatId: response.data.chat.id } });
  } catch (error) {
    return MessageModal("error", "Error", error.response?.data?.message || error.message);
  }
}
</script>
```

---

## 9. frontend/src/components/pages/ChatBox.vue (NEW FILE)

```vue
<template>Chat</template>
```

---

## 10. frontend/src/functions/api/chat.js (NEW FILE)

```javascript
export function apiGetChats(params = {}) {
  return axios.get(window.API_URL + '/chats', { params });
}
export function apiCreateChat(chatData) {
  return axios.post(window.API_URL + '/chats/create', chatData);
}
export function apiReadChat(chatId) {
  return axios.get(window.API_URL + `/chats/read/${chatId}`);
}
export function apiUpdateGroupChat(chatId, chatData) {
  return axios.patch(window.API_URL + `/chats/update/${chatId}`, chatData);
}
export function apiDeleteGroupChat(chatId) {
  return axios.delete(window.API_URL + `/chats/delete/${chatId}`);
}
export function apiLeaveGroupChat(chatId) {
  return axios.post(window.API_URL + `/chats/leave/${chatId}`);
}
export function apiGetChatFile(uri) {
  return axios.get(uri, {
    responseType: 'blob',
  });
}
```

---

## 11. frontend/src/functions/api/chat_member.js (NEW FILE)

```javascript
export function apiGetMembers(chatId, params = {}) {
  return axios.get(window.API_URL + `/chats/${chatId}/members`, { params });
}
export function apiAddMember(chatId, memberData) {
  return axios.post(window.API_URL + `/chats/${chatId}/members/add`, memberData);
}
export function apiUpdateMember(chatId, memberId, updateData) {
  return axios.patch(window.API_URL + `/chats/${chatId}/members/update/${memberId}`, updateData);
}
export function apiRemoveMember(chatId, memberId) {
  return axios.delete(window.API_URL + `/chats/${chatId}/members/remove/${memberId}`);
}
```

---

## 12. frontend/src/functions/api/chat_message.js (NEW FILE)

```javascript
export function apiGetMessages(chatId, params = {}) {
  return axios.get(window.API_URL + `/chats/${chatId}/messages`, { params });
}
export function apiCreateMessage(chatId, messageData) {
  return axios.post(window.API_URL + `/chats/${chatId}/messages/create`, messageData);
}
export function apiUpdateMessage(chatId, messageId, messageData) {
  return axios.patch(window.API_URL + `/chats/${chatId}/messages/update/${messageId}`, messageData);
}
export function apiDeleteMessage(chatId, messageId) {
  return axios.delete(window.API_URL + `/chats/${chatId}/messages/delete/${messageId}`);
}
export function apiMarkMessageAsSeen(chatId, messageId) {
  return axios.post(window.API_URL + `/chats/${chatId}/messages/seen/${messageId}`);
}
export function apiMarkAllMessagesAsSeen(chatId) {
  return axios.post(window.API_URL + `/chats/${chatId}/messages/seen-all`);
}
```

---

## 13. frontend/src/functions/api/user.js (NEW FILE)

```javascript
export function apiGetUsers(params = {}) {
  return axios.get(window.API_URL + '/users', { params });
}
```

---

## 14. frontend/src/functions/datetime.js (NEW FILE)

```javascript
import dayjs from 'dayjs';
import utc from 'dayjs/plugin/utc';
import timezone from 'dayjs/plugin/timezone';
import relativeTime from 'dayjs/plugin/relativeTime';

dayjs.extend(utc);
dayjs.extend(timezone);
dayjs.extend(relativeTime);

export function formatChatTime(utcTime) {
  if (!utcTime) return '';
  
  const local = dayjs.utc(utcTime).local();
  const now = dayjs();
  
  // If today, show time only
  if (local.isSame(now, 'day')) {
    return local.format('h:mm A'); // "2:00 PM"
  }
  
  // If yesterday
  if (local.isSame(now.subtract(1, 'day'), 'day')) {
    return 'Yesterday';
  }
  
  // If within a week, show day name
  if (local.isAfter(now.subtract(7, 'day'))) {
    return local.format('ddd'); // "Mon", "Tue"
  }
  
  // Otherwise show date
  return local.format('MMM D'); // "Jan 15"
}

export function formatFullDateTime(utcTime) {
  return dayjs.utc(utcTime).local().format('MMM D, YYYY h:mm A');
}

export function getRelativeTime(utcTime) {
  return dayjs.utc(utcTime).local().fromNow(); // "2 hours ago"
}
```

---

## Summary of Changes

### Key Features Implemented:

1. **Chat Search Functionality**: Added real-time search in sidebar for chats and users with 1-second debounce
2. **Recent Chats Display**: Shows recent chats sorted by last message time
3. **Chat API Integration**: Complete API functions for chats, members, and messages
4. **DateTime Formatting**: Smart time display (Today: "2:00 PM", Yesterday, Day name, or Date)
5. **Custom Chat Styling**: CSS animations and styling for chat items
6. **User Search**: Ability to search and start personal chats with users
7. **Chat Routing**: Added route for individual chat boxes
8. **Component Architecture**: Reusable ChatOption and UserOption components

### Dependencies Added:
- `dayjs` (v1.11.19) - For datetime handling and formatting

### UI Changes:
- Changed sidebar theme from `sidebar-dark-primary` to `sidebar-light-primary`
- Changed body class from `sidebar-mini` to `layout-fixed`
- Added custom CSS for chat item styling with animations
