# VPS Configuration Guide
Complete step-by-step guide to configure VPS from SSL setup to deployment

## Prerequisites
- VPS with Ubuntu (20.04 or later)
- Root or sudo access
- Domain name with DNS configured (A record pointing to VPS IP)
- SSH access to VPS

---

## Part 1: SSL Certificate with Certbot

### 1.1 Install Certbot and Nginx
```bash
sudo apt update
sudo apt install -y certbot nginx
```

### 1.2 Stop Nginx (required for standalone mode)
```bash
sudo systemctl stop nginx
```

### 1.3 Obtain SSL Certificate

**Option A: Main Domain Only**
```bash
sudo certbot certonly --standalone -d example.cloud -d www.example.cloud
```

**Option B: Main Domain + Subdomain**
```bash
sudo certbot certonly --standalone -d example.cloud -d www.example.cloud -d api.example.cloud
```

**Option C: Multiple Subdomains**
```bash
sudo certbot certonly --standalone \
  -d example.cloud \
  -d www.example.cloud \
  -d api.example.cloud \
  -d admin.example.cloud
```

### 1.4 Verify Certificate Creation
```bash
# List all certificates
sudo certbot certificates

# Check certificate files
sudo ls -la /etc/letsencrypt/live/example.cloud/
```

Expected files:
- `fullchain.pem` - Full certificate chain
- `privkey.pem` - Private key
- `cert.pem` - Certificate only
- `chain.pem` - Chain only

### 1.5 Certificate Auto-Renewal
```bash
# Test renewal (dry run)
sudo certbot renew --dry-run

# Certbot automatically creates a cron job for renewal
# Check renewal timer
sudo systemctl status certbot.timer
```

---

## Part 3: Nginx Configuration

### 3.1 Create Nginx Configuration
```bash
sudo nano /etc/nginx/sites-available/example.cloud
sudo ln -s /etc/nginx/sites-available/example.cloud /etc/nginx/sites-enabled/example.cloud
sudo rm /etc/nginx/sites-enabled/default
```

### 3.2 Basic Configuration (Main Domain → Port 3000, /api → Port 8000)
```nginx
# ===== NGINX CONFIGURATION START =====

# Main HTTPS server
server {
    listen 443 ssl http2;
    server_name example.cloud www.example.cloud;

    # SSL files
    ssl_certificate /etc/letsencrypt/live/example.cloud/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.cloud/privkey.pem;

    # Send all web traffic to your app on port 3000
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
    }

    # Send all API traffic to your app on port 8000
    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
    }

    # Send all database traffic to your app on port 9000
    location /database/ {
        proxy_pass http://localhost:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
    }
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name example.cloud www.example.cloud;
    return 301 https://$host$request_uri;
}

# Block direct HTTP/IP access
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;
    return 444; # or 403;
}

# ===== NGINX CONFIGURATION END =====
```

### 3.4 Test and Apply Configuration
```bash
# Test configuration syntax
sudo nginx -t

# If test passes, start nginx
sudo systemctl start nginx

# Reload configuration
sudo systemctl reload nginx

# Check status
sudo systemctl status nginx

# Enable nginx on boot
sudo systemctl enable nginx
```

---

## Port Configuration Reference

| Service | Port | Access |
|---------|------|--------|
| HTTP | 80 | Public (redirects to 443) |
| HTTPS | 443 | Public (Nginx) |
| Laravel App | 8000 | Internal (Docker) |
| MySQL | 3306 | Internal (Docker) |
| Frontend | 3000 | Internal (Docker) |

---

## Next Steps

1. ✅ Configure domain DNS
2. ✅ Install SSL certificate
3. ✅ Configure Nginx reverse proxy
4. ✅ Implement security measures

Your VPS is now configured and ready for production!
