# Step 13: Verify User Account & Frontend Vue View Handling

This guide demonstrates how to implement user account verification with Vuex state management, route guards, and AdminLTE layout integration.

---

## Overview

In this step, you will:
1. Add new authentication API endpoints for account verification and password change
2. Implement Vuex store for global user state management
3. Create route guards to protect authenticated pages
4. Build reusable layout components (Navbar, Sidebar, Footer)
5. Create a user profile page with password change functionality

---

## Backend Changes

### 1. Add New API Endpoints

**File:** `routes/api.php`

```php
// Group protected routes under auth:sanctum middleware
Route::middleware('auth:sanctum')->group(function () {
    Route::post('/signout', [AuthController::class, 'signout']);
    Route::patch('/token/refresh', [AuthController::class, 'refreshToken']);
    Route::get('/verify/account', [AuthController::class, 'verifyAccount']);
    Route::patch('/password/change', [AuthController::class, 'changePassword']);
    Route::patch('/password/create', [AuthController::class, 'createPassword']);
});
```

### 2. Add Controller Methods

**File:** `app/Http/Controllers/API/AuthController.php`

**Verify Account Method:**
```php
function verifyAccount(Request $request)
{
    $user = $request->user();

    return response([
        'message' => 'Account is valid.',
        'user' => $user
    ], 200);
}
```

**Change Password Method:**
```php
function changePassword(Request $request)
{
    $request->validate([
        'old_password' => 'required|string',
        'new_password' => 'required|string|min:6|max:10|confirmed',
        'terminate_sessions' => 'required|boolean'
    ]);

    $user = $request->user();

    if (!Hash::check($request->old_password, $user->password)) {
        throw ValidationException::withMessages([
            'old_password' => 'Old password does not match.',
        ]);
    }

    try {
        DB::beginTransaction();
        $user->password = Hash::make($request->new_password);
        $user->save();

        if ($request->terminate_sessions) {
            // Delete all tokens
            $user->tokens()->delete();
        } else {
            // Delete current token only
            $currentToken = $user->currentAccessToken();
            $user->tokens()->where('id', $currentToken->id)->delete();
        }
        
        DB::commit();
    } catch (\Exception $e) {
        DB::rollBack();
        throw new \Exception($e->getMessage());
    }

    return response([
        'message' => 'Password changed successfully.'
    ], 200);
}
```

**Create Password Method:**
```php
function createPassword(Request $request)
    {
        $request->validate([
            'new_password' => 'required|string|min:6|max:10|confirmed',
            'terminate_sessions' => 'required|boolean'
        ]);

        $user = $request->user();

        try {
            DB::beginTransaction();
            $user->password = Hash::make($request->new_password);
            $user->save();

            if ($request->terminate_sessions) {
                // delete all tokens
                $user->tokens()->delete();
            } else {
                // delete current token only
                $currentToken = $user->currentAccessToken();
                $user->tokens()->where('id', $currentToken->id)->delete();
            }

            DB::commit();
        } catch (\Exception $e) {
            DB::rollBack();
            throw new \Exception($e->getMessage());
        }

        return response([
            'message' => 'Password created successfully.'
        ], 200);
    }
```

---

## Frontend Changes

### 1. Install Vuex

Vuex is a state management pattern and library for Vue.js applications. It serves as a centralized store for all components.

**Navigate to frontend folder and install Vuex:**

```bash
cd frontend
npm install vuex
```

This will automatically update your `frontend/package.json` file with:
```json
{
  "dependencies": {
    "vuex": "^4.1.0"
  }
}
```

Wait for the installation to complete before proceeding to the next step.

### 2. Add API Functions

**File:** `frontend/src/functions/api/auth.js`

```javascript
// Existing imports and functions...
export async function getVerifyAccount(token) {
    return await axios.get(window.API_URL + '/verify/account', {
        headers: {
            Authorization: `Bearer ${token}`
        }
    });
}
export async function patchChangePassword(user) {
    return await axios.patch(window.API_URL + '/password/change', user);
}
export async function patchCreatePassword(user) {
    return await axios.patch(window.API_URL + '/password/create', user);
}
```

### 3. Setup Vuex Store & Router Guards

**File:** `frontend/src/main.js`

```javascript
import 'admin-lte/plugins/bootstrap/js/bootstrap.bundle.min.js';
import 'admin-lte/dist/js/adminlte.min.js';

import Swal from 'sweetalert2';
window.Swal = Swal;

import axios from 'axios';
window.axios = axios;

window.API_URL = import.meta.env.VITE_API_URL;

import { createApp } from 'vue';
import { createStore } from 'vuex';
import App from './App.vue';
import router from './router';
import { getVerifyAccount } from '@func/api/auth';
const app = createApp(App);

// Create Vuex store
const store = createStore({
    state: {
        user: null,
    },
    mutations: {
        setUser(state, user) {
            state.user = user;
        },
    },
    actions: {
        async verifyAccount({ commit }) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    localStorage.removeItem('token');
                    return commit('setUser', null);
                }
                axios.defaults.headers.common['Authorization'] = token ? `Bearer ${token}` : '';
                const response = await getVerifyAccount(token);
                return commit('setUser', response.data.user);
            } catch (error) {
                localStorage.removeItem('token');
                commit('setUser', null);
            }
        }
    }
});

app.use(router);
app.use(store);
app.mount('#app');

router.beforeEach(async (to, from, next) => {
    await store.dispatch('verifyAccount');
    const guard = Boolean(to.meta.guard);
    const isAuthenticated = Boolean(store.state.user !== null);
    if (!guard && isAuthenticated) {
        return next({ name: 'dashboard' })
    }
    if (guard && !isAuthenticated) {
        return next({ name: 'auth.signin' });
    }
    return next();
});
```

### 4. Update Components to Use Vuex

**File:** `frontend/src/components/auth/Signin.vue`

```javascript
import { useStore } from "vuex";

const store = useStore();

async function signIn() {
    const response = await postSignIn(user);
    localStorage.setItem("token", response.data.token);
    await store.dispatch("verifyAccount");
    router.replace({ name: "dashboard" });
}
```

**File:** `frontend/src/components/auth/GoogleCallback.vue`

```javascript
import { useStore } from "vuex";

const store = useStore();

onMounted(async () => {
    const response = await patchRefreshToken(token);
    localStorage.setItem("token", response.data.token);
    await store.dispatch("verifyAccount");
    router.replace({ name: "dashboard" });
});
```

### 5. Create Layout Components

**File:** `frontend/src/components/includes/Navbar.vue`

```vue
<template>
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button">
          <i class="fas fa-bars"></i>
        </a>
      </li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>
      <li class="nav-item">
        <router-link :to="{ name: 'auth.signout' }" class="nav-link text-danger">
          <i class="nav-icon fas fa-sign-out-alt"></i>
        </router-link>
      </li>
    </ul>
  </nav>
</template>
```

**File:** `frontend/src/components/includes/Sidebar.vue`

```vue
<template>
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <router-link :to="{ name: 'dashboard' }" class="brand-link">
      <img :src="logoImg" alt="AdminLTE Logo" class="brand-image img-circle elevation-3" />
      <span class="brand-text font-weight-light">AdminLTE 3</span>
    </router-link>
    <div class="sidebar">
      <router-link :to="{ name: 'profile' }">
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          <div class="image">
            <img :src="profilePic" class="img-circle elevation-2" alt="User Image" />
          </div>
          <div class="info">
            <a href="#" class="d-block">Nina Mcintire</a>
          </div>
        </div>
      </router-link>
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column">
          <li class="nav-item">
            <router-link :to="{ name: 'dashboard' }" class="nav-link" active-class="active">
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>Dashboard</p>
            </router-link>
          </li>
        </ul>
      </nav>
    </div>
  </aside>
</template>

<script setup>
import logoImg from "admin-lte/dist/img/AdminLTELogo.png";
import profilePic from "admin-lte/dist/img/user4-128x128.jpg";
</script>
```

**File:** `frontend/src/components/includes/Footer.vue`

```vue
<template>
  <footer class="main-footer">
    <div class="float-right d-none d-sm-inline">Anything you want</div>
    <strong>Copyright © 2014-2021 <a href="https://adminlte.io">AdminLTE.io</a>.</strong>
    All rights reserved.
  </footer>
</template>
```

### 6. Update App.vue

**File:** `frontend/src/App.vue`

```vue
<template>
  <router-view name="navbar"></router-view>
  <router-view name="sidebar"></router-view>
  <router-view></router-view>
  <router-view name="footer"></router-view>
</template>
```

### 7. Update Router with Named Views

**File:** `frontend/src/router/index.js`

```javascript
import Signin from '@com/auth/Signin.vue';
import Signout from '@com/auth/Signout.vue';
import Signup from '@com/auth/Signup.vue';
import VerifyEmail from '@com/auth/VerifyEmail.vue';
import ResetPassword from '@com/auth/ResetPassword.vue';
import SetNewPassword from '@com/auth/SetNewPassword.vue';
import GoogleCallback from '@com/auth/GoogleCallback.vue';
import GoogleCallbackError from '@com/auth/GoogleCallbackError.vue';
import UserProfile from '@com/auth/UserProfile.vue';
import Dashboard from '@com/pages/Dashboard.vue';

import { createRouter, createWebHistory } from 'vue-router'
import Navbar from '@com/includes/Navbar.vue';
import Footer from '@com/includes/Footer.vue';
import Sidebar from '@/components/includes/Sidebar.vue';

const includes = {
  navbar: Navbar,
  sidebar: Sidebar,
  footer: Footer,
}
const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [
    {
      path: '/',
      name: 'auth.signin',
      component: Signin,
      meta: { guard: false },
    },
    {
      path: '/signout',
      name: 'auth.signout',
      component: Signout,
      meta: { guard: true },
    },
    {
      path: '/signup',
      name: 'auth.signup',
      component: Signup,
      meta: { guard: false },
    },
    {
      path: '/email/verify/:api_url',
      name: 'auth.verify.email',
      component: VerifyEmail,
      meta: { guard: false },
    },
    {
      path: '/password/reset',
      name: 'auth.reset.password',
      component: ResetPassword,
      meta: { guard: false },
    },
    {
      path: '/password/reset/:api_url',
      name: 'auth.set.password',
      component: SetNewPassword,
      meta: { guard: false },
    },
    {
      path: '/auth/google/callback',
      name: 'auth.google.callback',
      component: GoogleCallback,
      meta: { guard: false },
    },
    {
      path: '/auth/google/callback/error',
      name: 'auth.google.callback.error',
      component: GoogleCallbackError,
      meta: { guard: false },
    },
    {
      path: '/dashboard',
      name: 'dashboard',
      components: {
        default: Dashboard,
        ...includes,
      },
      meta: { guard: true },
    },
    {
      path: '/profile',
      name: 'profile',
      components: {
        default: UserProfile,
        ...includes,
      },
      meta: { guard: true },
    }
  ],
})

export default router
```

### 8. Create User Profile Page

**File:** `frontend/src/components/auth/UserProfile.vue`

```vue
<template>
  <div class="content-wrapper" style="min-height: 1416px">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Profile</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item">
                <router-link :to="{ name: 'dashboard' }">Home</router-link>
              </li>
              <li class="breadcrumb-item active">Profile</li>
            </ol>
          </div>
        </div>
      </div>
      <!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-3">
            <!-- Profile Image -->
            <div class="card card-primary card-outline">
              <div class="card-body box-profile">
                <div class="text-center">
                  <img
                    class="profile-user-img img-fluid img-circle"
                    :src="profilePic"
                    alt="User profile picture"
                  />
                </div>

                <h3 class="profile-username text-center">Nina Mcintire</h3>

                <p class="text-muted text-center">Software Engineer</p>

                <ul class="list-group list-group-unbordered mb-3">
                  <li class="list-group-item">
                    <b>Followers</b> <a class="float-right">1,322</a>
                  </li>
                  <li class="list-group-item">
                    <b>Following</b> <a class="float-right">543</a>
                  </li>
                  <li class="list-group-item">
                    <b>Friends</b> <a class="float-right">13,287</a>
                  </li>
                </ul>

                <!-- <a href="#" class="btn btn-primary btn-block"><b>Follow</b></a> -->
              </div>
            </div>
          </div>
          <div class="col-md-9">
            <div class="card">
              <div class="card-header p-2">
                <ul class="nav nav-pills">
                  <li class="nav-item">
                    <a class="nav-link active" href="#password_settings" data-toggle="tab"
                      >Password Settings</a
                    >
                  </li>
                </ul>
              </div>
              <div class="card-body">
                <div class="tab-content">
                  <div class="active tab-pane" id="password_settings">
                    <form @submit.prevent="changePassword" class="form-horizontal">
                      <div v-if="!loggedUser.password_null" class="form-group row">
                        <label class="col-sm-2 col-form-label">Old Password</label>
                        <div class="col-sm-10">
                          <input
                            v-model="user.old_password"
                            type="password"
                            class="form-control"
                            placeholder="Old Password"
                            :class="!!userError.old_password ? 'is-invalid' : ''"
                          />
                          <div class="invalid-feedback">
                            {{ userError.old_password }}
                          </div>
                        </div>
                      </div>
                      <div class="form-group row">
                        <label class="col-sm-2 col-form-label">New Password</label>
                        <div class="col-sm-10">
                          <input
                            v-model="user.new_password"
                            type="password"
                            class="form-control"
                            placeholder="New Password"
                            :class="!!userError.new_password ? 'is-invalid' : ''"
                          />
                          <div class="invalid-feedback">
                            {{ userError.new_password }}
                          </div>
                        </div>
                      </div>
                      <div class="form-group row">
                        <label class="col-sm-2 col-form-label">Confirm Password</label>
                        <div class="col-sm-10">
                          <input
                            v-model="user.new_password_confirmation"
                            type="password"
                            class="form-control"
                            placeholder="Confirm Password"
                          />
                        </div>
                      </div>
                      <div class="form-group row">
                        <div class="offset-sm-2 col-sm-10">
                          <div class="checkbox">
                            <label>
                              <input v-model="user.terminate_sessions" type="checkbox" />
                              Terminate all sessions
                            </label>
                          </div>
                        </div>
                      </div>
                      <div class="form-group row">
                        <div class="offset-sm-2 col-sm-10">
                          <button type="reset" class="mx-3 btn btn-danger">Cancel</button>
                          <button type="submit" class="mx-3 btn btn-outline-primary">
                            Save
                          </button>
                        </div>
                      </div>
                    </form>
                  </div>
                  <!-- /.tab-pane -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</template>

<script setup>
import profilePic from "admin-lte/dist/img/user4-128x128.jpg";
import { CloseModal, LoadingModal, MessageModal } from "@func/swal";
import { useRouter } from "vue-router";
import { computed, reactive } from "vue";
import { patchChangePassword, patchCreatePassword } from "@func/api/auth";
import { useStore } from "vuex";
const store = useStore();
const loggedUser = computed(() => store.state.user);

const router = useRouter();
const user = reactive({
  old_password: "",
  new_password: "",
  new_password_confirmation: "",
  terminate_sessions: false,
});

const userError = reactive({
  old_password: "",
  new_password: "",
});

async function changePassword() {
  try {
    LoadingModal();
    let response;
    if (loggedUser.value.password_null) {
      response = await patchCreatePassword(user);
    } else {
      response = await patchChangePassword(user);
    }
    await MessageModal("success", "Success", response.data.message, () =>
      router.push({ name: "dashboard" })
    );
  } catch (error) {
    if (!error.response) {
      return MessageModal("error", "Error", error.message);
    }
    if (error.response.status === 422) {
      Object.keys(userError).forEach((key) => {
        userError[key] = error.response.data.errors[key]
          ? error.response.data.errors[key][0]
          : "";
      });
      return CloseModal();
    }
    return MessageModal("error", "Error", error.response.data.message);
  }
}
</script>
```

### 9. Update Dashboard Page

**File:** `frontend/src/components/pages/Dashboard.vue`

```vue
<template>
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Dashboard</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item">
                <router-link :to="{ name: 'dashboard' }">Home</router-link>
              </li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid"></div>
    </section>
  </div>
</template>
```

### 10. Update HTML Body Class

**File:** `frontend/index.html`

```html
<body class="sidebar-mini" style="height: auto;">
  <div id="app" class="wrapper"></div>
  <script type="module" src="/src/main.js"></script>
</body>
```

---

## Key Concepts

### Vuex State Management
- Centralized user state across all components
- `state`: Stores user data
- `mutations`: Synchronous state changes
- `actions`: Asynchronous operations (API calls)

### Route Guards
- `meta.guard`: Defines if route requires authentication
- `router.beforeEach`: Checks authentication before each route
- Redirects unauthenticated users to signin
- Redirects authenticated users away from auth pages

### Named Router Views
- Multiple components rendered in one route
- Layout components (navbar, sidebar, footer) stay consistent
- Main content changes based on route

### Password Change Features
- Old password verification
- New password with confirmation
- Option to terminate all sessions or current session only
- Transaction-based updates for data integrity

---

## Testing

1. **Verify Account on Login:**
   - Sign in and check browser developer tools
   - Vuex state should contain user data

2. **Route Guards:**
   - Try accessing `/dashboard` without login → redirects to signin
   - Try accessing `/signin` while logged in → redirects to dashboard

3. **Change Password:**
   - Go to `/profile`
   - Fill in old and new passwords
   - Test "Terminate all sessions" checkbox
   - After submission, you should be logged out

4. **Layout Consistency:**
   - Navigate between dashboard and profile
   - Navbar, sidebar, and footer should remain visible

---

## Summary

You've successfully implemented:
✅ Account verification API endpoints  
✅ Vuex store for global state management  
✅ Route guards for authentication  
✅ Reusable layout components  
✅ User profile with password change functionality  
✅ AdminLTE integration with Vue Router named views

Your application now has a complete authentication system with protected routes and proper state management!
