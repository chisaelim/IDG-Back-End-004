# 12. Google OAuth Integration

This guide demonstrates how to integrate Google OAuth authentication into our Laravel backend and Vue.js frontend application. Users will be able to sign in or sign up using their Google accounts seamlessly with enhanced security through token exchange.

## What We'll Implement

1. Google Cloud Console setup for OAuth2
2. Laravel backend with Google OAuth routes and controller
3. Database migration for nullable passwords
4. Frontend OAuth buttons and secure token handling
5. Complete authentication flow with secure token exchange mechanism

## Prerequisites

- Completed guides 11.1-11.4 (Authentication System Setup)
- Google Account for Google Cloud Console access
- Laravel Socialite package
- Working Docker environment
- Existing token refresh endpoint in your authentication system

## Step 1: Google Cloud Console Setup

### 1.1 Create Google Cloud Project

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select an existing one
3. Enable the Google+ API for your project

### 1.2 Configure OAuth Consent Screen

1. Navigate to "APIs & Services" > "OAuth consent screen"
2. Choose "External" user type
3. Fill in the required information:
   - Application name: Your app name
   - User support email: Your email
   - Developer contact information: Your email
4. Add scopes: `email`, `profile`, `openid`
5. Save and continue

### 1.3 Create OAuth2 Credentials

1. Navigate to "APIs & Services" > "Credentials"
2. Click "Create Credentials" > "OAuth client ID"
3. Choose "Web application"
4. Add authorized redirect URIs:
   ```
   http://localhost:8000/api/auth/google/callback
   ```
5. Note down your Client ID and Client Secret

## Step 2: Backend Implementation

### 2.1 Install Laravel Socialite

Add Laravel Socialite to your composer dependencies:

```bash
composer require laravel/socialite
```

### 2.2 Environment Configuration

Update your `.env` file with Google OAuth credentials:

```env
# Google OAuth Configuration
GOOGLE_CLIENT_ID=your_google_client_id_here
GOOGLE_CLIENT_SECRET=your_google_client_secret_here
GOOGLE_REDIRECT_URL=http://localhost:8000/api/auth/google/callback
```

### 2.3 Service Provider Configuration

Update `config/services.php` to include Google OAuth configuration:

```php
<?php

return [
    // ... existing configurations

    'google' => [
        'client_id' => env('GOOGLE_CLIENT_ID'),
        'client_secret' => env('GOOGLE_CLIENT_SECRET'),
        'redirect' => env('GOOGLE_REDIRECT_URL'),
    ],
];
```

### 2.4 Create Google Auth Controller

Create a new controller for handling Google OAuth:

```bash
php artisan make:controller GoogleAuthController
```

Implement the Google OAuth logic with secure token handling:

```php
<?php
// app/Http/Controllers/GoogleAuthController.php

namespace App\Http\Controllers;

use App\Models\User;
use Illuminate\Http\Request;
use Laravel\Socialite\Facades\Socialite;

class GoogleAuthController extends Controller
{
    public function redirectToGoogle()
    {
        return Socialite::driver('google')->stateless()->redirect();
    }

    public function handleGoogleCallback()
    {
        try {
            $googleUser = Socialite::driver('google')->stateless()->user();
            
            // Find or create user by email only
            $user = User::firstOrCreate(
                ['email' => $googleUser->getEmail()],
                [
                    'name' => $googleUser->getName(),
                    'email_verified_at' => now(),
                ]
            );

            // Create short-lived token (1 minute) for security
            $token = $user->createToken('auth_token', ['*'], now()->addMinute())->plainTextToken;

            // Redirect to frontend with short-lived token
            return redirect()->away(
                env('APP_FRONTEND_URL') . '/auth/google/callback?token=' . $token
            );

        } catch (\Exception $e) {
            return redirect()->away(
                env('APP_FRONTEND_URL') . '/auth/google/callback/error'
            );
        }
    }
}
```

Add new function refreshToken to AuthController:

```php
<?php

namespace App\Http\Controllers\API;

use Hash;
use App\Models\User;
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Password;
use Illuminate\Validation\ValidationException;

class AuthController extends Controller
{
    // ... existing methods
    function refreshToken(Request $request)
    {
        $user = $request->user();

        // method 1
        $currentToken = $user->currentAccessToken();
        $user->tokens()->where('id', $currentToken->id)->delete();

        // method 2
        // $user->currentAccessToken()->delete();

        // Create new token
        $token = $user->createToken('auth_token')->plainTextToken;

        return response([
            'message' => 'Token refreshed successfully.',
            'token' => $token
        ], 200);
    }
}

```

### 2.5 Database Migration for Nullable Passwords

Create a migration to make passwords nullable for OAuth users:

```bash
php artisan make:migration make_password_nullable_in_users_table
```

Implement the migration:

```php
<?php
// database/migrations/2025_01_07_000000_make_password_nullable_in_users_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('password')->nullable()->change();
        });
    }

    public function down(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('password')->nullable(false)->change();
        });
    }
};
```

Run the migration:

```bash
php artisan migrate
```

### 2.6 Add OAuth Routes

Update `routes/api.php` to include Google OAuth routes:

```php
<?php
// routes/api.php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\API\AuthController;
use App\Http\Controllers\GoogleAuthController;

// Existing authentication routes
Route::post('/signup', [AuthController::class, 'signup']);
Route::post('/signin', [AuthController::class, 'signin']);
Route::post('/signout', [AuthController::class, 'signout'])->middleware('auth:sanctum');
Route::get('/email/verify/{id}/{hash}', [AuthController::class, 'verifyEmail'])->middleware('signed')->name('verify.email');
Route::post('/email/verify/resend', [AuthController::class, 'resendVerificationMail'])->middleware('throttle:3,1');
Route::post('/password/forgot', [AuthController::class, 'sendResetPasswordMail']);
Route::post('/password/reset', [AuthController::class, 'setNewPassword'])->name('reset.password');

// Token refresh route
Route::patch('token/refresh', [AuthController::class, 'refreshToken'])->middleware('auth:sanctum');

// Google OAuth routes
Route::get('/auth/google', [GoogleAuthController::class, 'redirectToGoogle']);
Route::get('/auth/google/callback', [GoogleAuthController::class, 'handleGoogleCallback']);
```

## Step 3: Frontend Implementation

### 3.1 Update Authentication API Functions

Update `frontend/src/functions/api/auth.js` to include token refresh functionality:

```javascript
// Add this function to your existing auth.js file
export async function patchRefreshToken(token) {
    return await axios.patch(window.API_URL + '/token/refresh', null, {
        headers: {
            Authorization: `Bearer ${token}`
        }
    });
}
```

### 3.2 Create Google Callback Component

Create a new component to handle Google OAuth callbacks:

```vue
<!-- frontend/src/components/auth/GoogleCallback.vue -->
<template>
  <div class="login-page">
    <div class="login-box">
      <div class="card card-outline card-primary">
        <div class="card-body text-center">
          <p class="login-box-msg">Processing Google authentication...</p>
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { onMounted } from "vue";
import { useRoute, useRouter } from "vue-router";
import { MessageModal } from "@func/swal";
import { patchRefreshToken } from "@func/api/auth";

const route = useRoute();
const router = useRouter();

onMounted(async () => {
  try {
    const token = route.query.token;

    if (token) {
      // Exchange short-lived OAuth token for a proper session token
      const response = await patchRefreshToken(token);
      localStorage.setItem("token", response.data.token);
      router.replace({ name: "dashboard" });
    } else {
      router.replace({ name: "auth.signin" });
    }
  } catch (error) {
    MessageModal("error", "Error", "An error occurred during authentication.");
    router.replace({ name: "auth.signin" });
  }
});
</script>
```

### 3.3 Create Google Callback Error Component

Create an error component for failed OAuth attempts:

```vue
<!-- frontend/src/components/auth/GoogleCallbackError.vue -->
<template>
  <div class="login-page">
    <div class="login-box">
      <div class="card card-outline card-danger">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-exclamation-triangle fa-3x text-danger"></i>
          </div>
          <h4 class="login-box-msg text-danger">Google Authentication Failed</h4>
          <p class="text-muted mb-4">
            We couldn't sign you in with Google. This could be due to:
          </p>
          <ul class="text-left text-muted mb-4">
            <li>You cancelled the Google sign-in process</li>
            <li>There was a temporary issue with Google's servers</li>
            <li>Your Google account may not have the required permissions</li>
          </ul>
          <div class="row">
            <div class="col-6">
              <button @click="tryAgain" class="btn btn-danger btn-block">
                <i class="fab fa-google mr-2"></i> Try Again
              </button>
            </div>
            <div class="col-6">
              <button @click="goToSignin" class="btn btn-outline-secondary btn-block">
                <i class="fas fa-sign-in-alt mr-2"></i> Sign In
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { useRouter } from 'vue-router';
import { LoadingModal, MessageModal } from '@func/swal';

const router = useRouter();

function tryAgain() {
  try {
    LoadingModal();
    window.location.href = `${window.API_URL}/auth/google`;
  } catch (error) {
    MessageModal("error", "Error", "Failed to redirect to Google. Please try again.");
  }
}

function goToSignin() {
  router.push({ name: 'auth.signin' });
}
</script>
```

### 3.4 Add Google OAuth Routes

Update `frontend/src/router/index.js` to include the Google callback routes:

```javascript
// frontend/src/router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import Signin from '@com/auth/Signin.vue';
import Signout from '@com/auth/Signout.vue';
import Signup from '@com/auth/Signup.vue';
import VerifyEmail from '@com/auth/VerifyEmail.vue';
import ResetPassword from '@com/auth/ResetPassword.vue';
import SetNewPassword from '@com/auth/SetNewPassword.vue';
import GoogleCallback from '@com/auth/GoogleCallback.vue';
import GoogleCallbackError from '@com/auth/GoogleCallbackError.vue';
import Dashboard from '@com/pages/Dashboard.vue';

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [
    {
      path: '/',
      name: 'auth.signin',
      component: Signin,
    },
    {
      path: '/signout',
      name: 'auth.signout',
      component: Signout,
    },
    {
      path: '/signup',
      name: 'auth.signup',
      component: Signup,
    },
    {
      path: '/email/verify/:api_url',
      name: 'auth.verify.email',
      component: VerifyEmail,
    },
    {
      path: '/password/reset',
      name: 'auth.reset.password',
      component: ResetPassword,
    },
    {
      path: '/password/reset/:api_url',
      name: 'auth.set.password',
      component: SetNewPassword,
    },
    {
      path: '/auth/google/callback',
      name: 'auth.google.callback',
      component: GoogleCallback,
    },
    {
      path: '/auth/google/callback/error',
      name: 'auth.google.callback.error',
      component: GoogleCallbackError,
    },
    {
      path: '/dashboard',
      name: 'dashboard',
      component: Dashboard,
      meta: { requiresAuth: true }
    }
  ]
});

export default router;
```

### 3.5 Update Sign In Component

Update `frontend/src/components/auth/Signin.vue` to include Google OAuth button:

```vue
<!-- Add this after the form and before the forgot password link -->
<div class="social-auth-links text-center mt-2 mb-3">
  <button @click="googleSignIn" class="btn btn-block btn-danger">
    <i class="fab fa-google-plus mr-2"></i> Sign in using Google+
  </button>
</div>
```

Add the Google sign-in function to the script section:

```javascript
// Add this function in the script setup section
function googleSignIn() {
  try {
    LoadingModal();
    window.location.href = `${window.API_URL}/auth/google`;
  } catch (error) {
    MessageModal("error", "Error", "Google sign-in failed");
  }
}
```

### 3.6 Update Sign Up Component

Update `frontend/src/components/auth/Signup.vue` to include Google OAuth button:

```vue
<!-- Add this after the form and before the sign-in link -->
<div class="social-auth-links text-center mt-2 mb-3">
  <button @click="googleSignUp" class="btn btn-block btn-danger">
    <i class="fab fa-google-plus mr-2"></i> Sign up using Google+
  </button>
</div>
```

Add the Google sign-up function to the script section:

```javascript
// Add this function in the script setup section
function googleSignUp() {
  try {
    LoadingModal();
    window.location.href = `${window.API_URL}/auth/google`;
  } catch (error) {
    MessageModal("error", "Error", "Google sign-up failed");
  }
}
```

## Step 4: Testing the Implementation

### 4.1 Start Your Development Environment

Ensure both Laravel and Vue.js containers are running:

```bash
# Laravel backend (port 8000)
docker-compose up laravel

# Vue.js frontend (port 5173)
docker-compose up vue
```

### 4.2 Test Google OAuth Flow

1. Visit `http://localhost:5173/` (signin page)
2. Click "Sign in using Google+"
3. You'll be redirected to Google's OAuth consent screen
4. Grant permissions to your application
5. You'll be redirected back with a processing screen
6. The short-lived token gets exchanged for a proper session token
7. You're automatically signed in and redirected to the dashboard

### 4.3 Verify User Creation

Check your database to ensure users are created with:
- Correct email from Google account
- Name from Google profile
- `email_verified_at` set automatically
- `password` field as NULL

## Security Features Implemented

### 1. **Token Exchange Security Pattern**
- **Short-lived OAuth token**: 1-minute expiration to minimize exposure
- **Immediate exchange**: Frontend immediately trades OAuth token for session token
- **URL cleanup**: Session token never appears in URLs after exchange

### 2. **Secure Token Flow**
1. Google OAuth ΓåÆ Backend creates 1-minute token ΓåÆ URL redirect
2. Frontend catches token ΓåÆ Calls `patchRefreshToken(token)` API
3. Backend validates short token ΓåÆ Returns new long-lasting token
4. Frontend stores secure token, discards OAuth token

### 3. **Additional Security Measures**
- **Stateless OAuth**: API-compatible authentication
- **Automatic verification**: Google-verified emails are trusted
- **Environment variables**: Sensitive credentials secured
- **Error handling**: Graceful fallback to signin on failures

## Key Features Implemented

1. **Seamless OAuth Flow**: Users authenticate with Google in one click
2. **Automatic User Creation**: New users created from Google profile data
3. **Email Verification Bypass**: OAuth users are automatically verified
4. **Secure Token Management**: Short-lived tokens exchanged for session tokens
5. **Error Handling**: User-friendly error page for failed authentications
6. **Unified Authentication**: OAuth users access same protected routes

## Troubleshooting

### Common Issues

1. **OAuth Consent Screen**: Ensure all required fields are filled in Google Console
2. **Redirect URI Mismatch**: Verify redirect URI matches exactly in Google Console
3. **Missing Scopes**: Ensure email and profile scopes are enabled
4. **Token Exchange Errors**: Check that `refreshToken` endpoint exists and works
5. **Migration Issues**: Install `doctrine/dbal` for column modifications

### Debug Steps

1. Check Laravel logs for authentication errors
2. Verify Google Console credentials and settings
3. Ensure database migration ran successfully (`php artisan migrate:status`)
4. Test token refresh endpoint independently
5. Verify frontend API URL configuration

This completes the secure Google OAuth integration! Users now have a seamless and secure way to authenticate using their Google accounts with proper token management and security best practices.
