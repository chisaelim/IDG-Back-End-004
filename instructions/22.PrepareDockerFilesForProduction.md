# Prepare Docker Files for Production
Quick guide to set up production Docker configuration

---

## Files to Create/Update

```
IDG-Back-End-004/
â”œâ”€â”€ Dockerfile                          # Updated: Add permissions
â”œâ”€â”€ docker-compose.prod.yml             # New: Backend production config
â”œâ”€â”€ production.sh                       # New: Backend startup script
â””â”€â”€ frontend/
    â”œâ”€â”€ Dockerfile                      # Updated: Add build stage
    â””â”€â”€ docker-compose.prod.yml         # New: Frontend production config
```

---

## 1. Backend Dockerfile

**File:** `Dockerfile`

**Add these lines at the end:**

```dockerfile
FROM php:8.2.0-apache

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Install required Linux libraries
RUN apt-get update -y && apt-get install -y \
    libicu-dev \
    libmariadb-dev \
    unzip zip \
    zlib1g-dev \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libjpeg62-turbo-dev \
    libzip-dev \
    mariadb-client

# Install PHP extensions
RUN docker-php-ext-install gettext intl pdo_mysql gd pcntl zip

# Configure GD extension with FreeType and JPEG support
RUN docker-php-ext-configure gd --enable-gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) gd

# Set Apache document root to /var/www/html/public
ENV APACHE_DOCUMENT_ROOT=/var/www/html/public
RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf
RUN sed -ri -e 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf

# Copy Composer and NodeJS from their official images
COPY --from=composer:2.2 /usr/bin/composer /usr/bin/composer
COPY --from=node:23.10.0 /usr/local /usr/local

# Copy project files
COPY . /var/www/html

# Set working directory
WORKDIR /var/www/html

# Set permissions for Laravel (PRODUCTION ADDITION)
RUN chown -R www-data:www-data /var/www/html/storage 
RUN chown -R www-data:www-data /var/www/html/bootstrap/cache /var/www/html/public
RUN chown -R www-data:www-data /var/www/html/public
RUN chmod +x /var/www/html/*.sh && \
    chown www-data:www-data /var/www/html/*.sh
```

---

## 2. Backend Production Docker Compose

**File:** `docker-compose.prod.yml`

```yaml
services:
  app:
    build: .
    image: example.cloud:latest
    container_name: example.cloud-container
    volumes:
      - .env/:/var/www/html/.env
    #   - ./:/var/www/html
    #   - node:/var/www/html/node_modules
    #   - laravel:/var/www/html/vendor
    command: sh /var/www/html/production.sh
    ports:
      - 8000:80
    depends_on:
      - mysql
    environment:
      # Application Settings
      APP_NAME: example
      APP_ENV: production
      APP_DEBUG: false
      APP_URL: https://example.cloud
      APP_FRONTEND_URL: https://example.cloud
      APP_EMAIL_VERIFICATION_URL: "https://example.cloud/email/verify"
      APP_PASSWORD_RESET_URL: "https://example.cloud/password/reset"

      # Google OAuth (CRITICAL)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REDIRECT_URL: "https://example.cloud/api/auth/google/callback"

      # Database Configuration
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
  mysql:
    image: mariadb:10.11.13
    container_name: mysql-example.cloud-container
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      TZ: UTC
    command: --sql-mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"
    volumes:
      - mysql:/var/lib/mysql
    ports:
      - 3306:3306
volumes:
  mysql:
    name: example.cloud-mysql
  node:
    name: example.cloud-node
  laravel:
    name: example.cloud-laravel
```

**Key changes from development:**
- Uses `production.sh` instead of `start.sh`
- APP_ENV=production, APP_DEBUG=false
- HTTPS URLs (https://example.cloud)
- Commented volume mounts (code baked into image)
- Uses environment variables from `.env` file

---

## 3. Backend Production Startup Script

**File:** `production.sh`

```bash
#!/bin/bash
set -e

# Install dependencies without production optimizations
composer install
npm install

# Generate key and run migrations first
php artisan key:generate --force
php artisan migrate --force

# Build frontend assets FIRST
npm run build

# THEN clear caches (this preserves the built assets)
php artisan optimize:clear

# Laravel optimizations
php artisan config:cache    
php artisan route:cache       
php artisan view:cache

# Create storage link if needed
php artisan storage:link

# Retry failed jobs
php artisan queue:retry all

# Start services
apache2-foreground &
php artisan reverb:start &
php artisan queue:work --tries=3 --timeout=600 &

wait
```

**Make executable:**
```bash
chmod +x production.sh
```

---

## 4. Frontend Dockerfile

**File:** `frontend/Dockerfile`

```dockerfile
## Development
FROM node:24.12.0-alpine AS development
WORKDIR /app
COPY . .

## Build stage
FROM node:24.12.0-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL
RUN npm run build

## Production
FROM nginx:alpine AS production

# Copy built files from build stage
COPY --from=build /app/dist /usr/share/nginx/html

# Create Nginx configuration for SPA routing
RUN cat > /etc/nginx/conf.d/default.conf <<'EOF'
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Handle all routes - send to index.html for Vue Router
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
EOF

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

**What changed:**
- Added `build` stage to compile Vue app
- Added `npm install` and `npm run build`
- Production stage copies built files from build stage

---

## 5. Frontend Production Docker Compose

**File:** `frontend/docker-compose.prod.yml`

```yaml
services:
  vue-production:
    build:
      context: .
      target: production
    image: my-front-production:latest
    container_name: my-front-production-container
    ports:
      - 3000:80
```

**Key changes:**
- Only production service (no development)
- No volume mounts (built files baked into image)
- HTTPS API URL

---

## 6. GitHub Actions Deployment

**File:** `.github/workflows/deploy.yml`

```yaml
name: CI/CD pipeline

on:
  push:
    branches: [week5]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Copy files to VPS via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "."
          target: "~/example.cloud"
          
      - name: Deploy Backend and Frontend on VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd ~/example.cloud
            docker compose -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.prod.yml up -d --build
            cd ~/example.cloud/frontend
            docker compose -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.prod.yml up -d --build
```

**What it does:**
1. Copies all files to VPS
2. Deploys backend using docker-compose.prod.yml
3. Deploys frontend using docker-compose.prod.yml

---

## Summary of Changes

| File | Action | Purpose |
|------|--------|---------|
| `Dockerfile` | Updated | Added file permissions for Laravel |
| `docker-compose.prod.yml` | Created | Backend production configuration |
| `production.sh` | Created | Backend startup with optimizations |
| `frontend/Dockerfile` | Updated | Added multi-stage build for Vue |
| `frontend/docker-compose.prod.yml` | Created | Frontend production configuration |
| `.github/workflows/deploy.yml` | Updated | Automated deployment enabled |

---

## Quick Deploy

```bash
# Commit all changes
git add .
git commit -m "Add production Docker configuration"
git push origin week5

# GitHub Actions will automatically:
# 1. Copy files to VPS
# 2. Build and deploy backend
# 3. Build and deploy frontend
```

Your production Docker setup is ready! ðŸš€
