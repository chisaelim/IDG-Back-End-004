# Create Custom Middleware for Role-Based Access Control

This guide implements role-based access control (RBAC) to restrict certain features to admin users only. It includes backend middleware for API protection and frontend route guards for UI navigation control.

---

## Backend Implementation

### 1. Add Level Column to Users Table

Create a migration to add the `level` column:

```bash
php artisan make:migration add_level_column_to_users_table
```

**Migration File:** `database/migrations/2026_01_20_144751_add_level_column_to_users_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->enum('level', ['user', 'admin'])->default('user')->after('photo');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('level');
        });
    }
};
```

Run the migration:

```bash
php artisan migrate
```

---

### 2. Create Admin Middleware

Generate the middleware:

```bash
php artisan make:middleware AdminMiddleware
```

**File:** `app/Http/Middleware/AdminMiddleware.php`

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;

class AdminMiddleware
{
    /**
     * Handle an incoming request.
     *
     * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
     */
    public function handle(Request $request, Closure $next): Response
    {
        $user = $request->user();
        if (!$user || $user->level !== 'admin') {
            throw new AccessDeniedHttpException('Access denied. Admins only.');
        }
        return $next($request);
    }
}
```

---

### 3. Register Middleware Alias

**File:** `bootstrap/app.php`

Add the import at the top:

```php
use App\Http\Middleware\AdminMiddleware;
```

Register the middleware alias in the `withMiddleware` section:

```php
->withMiddleware(function (Middleware $middleware): void {
    $middleware->alias([
        'admin' => AdminMiddleware::class
    ]);
})
```

**Complete Example:**

```php
<?php

use Illuminate\Foundation\Application;
use App\Http\Middleware\AdminMiddleware;
use Illuminate\Foundation\Configuration\Exceptions;
use Illuminate\Foundation\Configuration\Middleware;

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__ . '/../routes/web.php',
        api: __DIR__ . '/../routes/api.php',
        commands: __DIR__ . '/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware): void {
        $middleware->alias([
            'admin' => AdminMiddleware::class
        ]);
    })
    ->withExceptions(function (Exceptions $exceptions): void {
        //
    })->create();
```

---

### 4. Protect Routes with Admin Middleware

**File:** `routes/api.php`

Wrap admin-only routes with the `admin` middleware:

```php
Route::middleware('auth:sanctum')->group(function () {
    // Regular authenticated routes
    Route::post('/signout', [AuthController::class, 'signout']);
    Route::patch('/token/refresh', [AuthController::class, 'refreshToken']);
    Route::get('/verify/account', [AuthController::class, 'verifyAccount']);
    Route::patch('/password/change', [AuthController::class, 'changePassword']);
    Route::patch('/password/create', [AuthController::class, 'createPassword']);
    Route::patch('/update/photo', [AuthController::class, 'updateUserPhoto']);

    // Admin-only routes
    Route::middleware('admin')->group(function () {
        Route::prefix('backups')->group(function () {
            Route::get('/', [BackupController::class, 'getBackups']);
            Route::post('/create', [BackupController::class, 'createBackup']);
            Route::get('/download/{filename}', [BackupController::class, 'downloadBackup']);
            Route::delete('/delete/{filename}', [BackupController::class, 'deleteBackup']);
        });
    });
});
```

---

## Frontend Implementation

### 1. Create Route Guard Function

**File:** `frontend/src/router/index.js`

Add the import and authorization function before the router configuration:

```javascript
import { useStore } from 'vuex';

function authorize(roles) {
  return (to, from, next) => {
    const store = useStore();
    const user = store.state.user;
    if (user && roles.includes(user.level)) {
      return next();
    }
    return next({ name: 'dashboard' });
  }
}
```

---

### 2. Protect Frontend Routes

Add `beforeEnter` guard to admin-only routes:

```javascript
{
  path: '/backups',
  name: 'backups',
  components: {
    default: Backup,
    ...includes,
  },
  meta: { guard: true },
  beforeEnter: authorize(['admin'])
},
```

**Complete Router Example:**

```javascript
import Signin from '@com/auth/Signin.vue';
import Signout from '@com/auth/Signout.vue';
import Signup from '@com/auth/Signup.vue';
import VerifyEmail from '@com/auth/VerifyEmail.vue';
import ResetPassword from '@com/auth/ResetPassword.vue';
import SetNewPassword from '@com/auth/SetNewPassword.vue';
import GoogleCallback from '@com/auth/GoogleCallback.vue';
import GoogleCallbackError from '@com/auth/GoogleCallbackError.vue';
import UserProfile from '@com/auth/UserProfile.vue';
import Dashboard from '@com/pages/Dashboard.vue';
import Backup from '@com/pages/Backup.vue';

import { createRouter, createWebHistory } from 'vue-router'
import Navbar from '@com/includes/Navbar.vue';
import Footer from '@com/includes/Footer.vue';
import Sidebar from '@com/includes/Sidebar.vue';

import { useStore } from 'vuex';
function authorize(roles) {
  return (to, from, next) => {
    const store = useStore();
    const user = store.state.user;
    if (user && roles.includes(user.level)) {
      return next();
    }
    return next({ name: 'dashboard' });
  }
}

const includes = {
  navbar: Navbar,
  sidebar: Sidebar,
  footer: Footer,
}

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [
    // ... other routes ...
    {
      path: '/backups',
      name: 'backups',
      components: {
        default: Backup,
        ...includes,
      },
      meta: { guard: true },
      beforeEnter: authorize(['admin'])
    },
  ],
})

export default router
```

---

### 3. Conditionally Show Sidebar Menu Items

**File:** `frontend/src/components/includes/Sidebar.vue`

Add computed properties to check user role and conditionally render admin menu items:

**Add to script section:**

```javascript
import { useStore } from "vuex";
import { computed } from "vue";

const store = useStore();
const user = computed(() => store.state.user);
const isAdmin = computed(() => user.value && user.value.level === "admin");
```

**Update template with v-if directive:**

```vue
<li v-if="isAdmin" class="nav-header">Systems</li>
<li v-if="isAdmin" class="nav-item">
  <router-link :to="{ name: 'backups' }" class="nav-link" active-class="active">
    <i class="nav-icon fas fa-database"></i>
    <p>Backups</p>
  </router-link>
</li>
```

**Complete Sidebar Script Section:**

```vue
<script setup>
import logoImg from "admin-lte/dist/img/AdminLTELogo.png";
import profilePic from "admin-lte/dist/img/user4-128x128.jpg";
import { useStore } from "vuex";
import { computed } from "vue";
const store = useStore();
const user = computed(() => store.state.user);
const isAdmin = computed(() => user.value && user.value.level === "admin");
</script>
```

---

## Summary

This implementation provides two-layer protection:

1. **Backend Protection**: API routes are protected with `AdminMiddleware` that checks the user's `level` field
2. **Frontend Protection**: Vue Router guards prevent non-admin users from accessing admin pages, and the sidebar hides admin menu items

**Key Features:**
- Database column to store user roles (`user` or `admin`)
- Backend middleware to validate admin access on API calls
- Frontend route guards to prevent unauthorized navigation
- Conditional UI rendering based on user role
- Centralized authorization logic using Vuex store

**Testing:**
1. Create a user with `level='admin'` in the database
2. Login as admin and verify access to backup page
3. Login as regular user and verify backup menu is hidden
4. Try accessing `/backups` as regular user - should redirect to dashboard