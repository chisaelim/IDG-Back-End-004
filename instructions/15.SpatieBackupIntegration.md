# Spatie Laravel Backup Integration

This guide provides step-by-step instructions for integrating Spatie Laravel Backup into your Laravel application for automated database and file backups.

## Overview
Spatie Laravel Backup is a powerful package that allows you to:
- Backup your database (MySQL, PostgreSQL, SQLite, etc.)
- Backup your application files
- Store backups on multiple storage destinations (local, S3, Dropbox, etc.)
- Monitor backup health
- Clean up old backups automatically
- Receive notifications about backup status

---

## Installation

### 0. Docker Environment Setup (IMPORTANT)

If you're using Docker, you need to install the database dump utilities in your container.

**File: `Dockerfile`**

Add `mariadb-client` (for MySQL/MariaDB) to your package installation:

```dockerfile
# Install required Linux libraries
RUN apt-get update -y && apt-get install -y \
    libicu-dev \
    libmariadb-dev \
    unzip zip \
    zlib1g-dev \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libjpeg62-turbo-dev \
    libzip-dev \
    mariadb-client
```

**Rebuild your Docker image:**
```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

> **Note:** For PostgreSQL, install `postgresql-client` instead of `mariadb-client`

### 1. Install the Package

Install Spatie Laravel Backup via Composer:

**For Docker:**
```bash
composer require spatie/laravel-backup
```

### 2. Publish Configuration File

Publish the configuration file to customize backup settings:

**For Docker:**
```bash
php artisan vendor:publish --provider="Spatie\Backup\BackupServiceProvider"
```

This will create a `config/backup.php` file.

### 3. Configure Filesystem Disks (optional)

The package uses Laravel's filesystem to store backups. Update your `config/filesystems.php` if needed.

**File: `config/filesystems.php`**

Add a backup disk (optional, you can use existing disks):

```php
'disks' => [
    // ... existing disks
    
    'backup' => [
        'driver' => 'local',
        'root' => storage_path('app/backups'),
    ],
],
```

---

## Configuration

### Basic Configuration

**File: `config/backup.php`**

Key configuration sections:

#### 1. Backup Name
```php
'backup' => [
    'name' => env('APP_NAME', 'laravel-backup'),
```

#### 2. Database Selection
```php
'source' => [
    'databases' => [
        env('DB_CONNECTION', 'mysql'), // or 'mysql', 'pgsql', etc.
    ],
```

#### 3. Files to Include
```php
    'files' => [
        'include' => [
            base_path(), // Entire application
        ],
        'exclude' => [
            base_path('frontend'),
            base_path('vendor'),
            base_path('node_modules'),
        ],
    ],
],
```

#### 4. Storage Destination
```php
'destination' => [
    'disks' => [
        'local', // Can add 's3', 'dropbox', etc.
    ],
],
```

#### 5. Cleanup Settings
```php
'cleanup' => [
    'strategy' => \Spatie\Backup\Tasks\Cleanup\Strategies\DefaultStrategy::class,
    'default_strategy' => [
        'keep_all_backups_for_days' => 7,
        'keep_daily_backups_for_days' => 16,
        'keep_weekly_backups_for_weeks' => 8,
        'keep_monthly_backups_for_months' => 4,
        'keep_yearly_backups_for_years' => 2,
        'delete_oldest_backups_when_using_more_megabytes_than' => 5000,
    ],
],
```

---

## Usage

### Manual Backup Commands

#### Run a Full Backup
**Docker:**
```bash
php artisan backup:run
```

#### Backup Only Database
**Docker:**
```bash
php artisan backup:run --only-db
```

#### Backup Only Files
**Docker:**
```bash
php artisan backup:run --only-files
```

#### List All Backups
**Docker:**
```bash
php artisan backup:list
```

#### Clean Old Backups
**Docker:**
```bash
php artisan backup:clean
```

#### Monitor Backup Health
**Docker:**
```bash
php artisan backup:monitor
```

---

## Automated Backups with Task Scheduler

Schedule automatic backups using Laravel's task scheduler.

**File: `app/Console/Kernel.php` or `routes/console.php` (Laravel 11+)**

For Laravel 11+, add to `routes/console.php`:

```php
use Illuminate\Support\Facades\Schedule;

Schedule::command('backup:clean')->daily()->at('01:00');
Schedule::command('backup:run')->daily()->at('02:00');
Schedule::command('backup:monitor')->daily()->at('03:00');
```

For older Laravel versions, update `app/Console/Kernel.php`:

```php
protected function schedule(Schedule $schedule)
{
    $schedule->command('backup:clean')->daily()->at('01:00');
    $schedule->command('backup:run')->daily()->at('02:00');
    $schedule->command('backup:monitor')->daily()->at('03:00');
}
```

### Running the Scheduler

For local development, run:
```bash
php artisan schedule:work
```

For production, add to crontab:
```
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

---

## Notifications

### Email Notifications

Configure email notifications in `config/backup.php`:

```php
'notifications' => [
    'notifications' => [
        \Spatie\Backup\Notifications\Notifications\BackupHasFailedNotification::class => ['mail'],
        \Spatie\Backup\Notifications\Notifications\UnhealthyBackupWasFoundNotification::class => ['mail'],
        \Spatie\Backup\Notifications\Notifications\CleanupHasFailedNotification::class => ['mail'],
        \Spatie\Backup\Notifications\Notifications\BackupWasSuccessfulNotification::class => ['mail'],
        \Spatie\Backup\Notifications\Notifications\HealthyBackupWasFoundNotification::class => ['mail'],
        \Spatie\Backup\Notifications\Notifications\CleanupWasSuccessfulNotification::class => ['mail'],
    ],

    'notifiable' => \Spatie\Backup\Notifications\Notifiable::class,

    'mail' => [
        'to' => env('MAIL_USERNAME', 'your-email@example.com'),
        'from' => [
            'address' => env('MAIL_FROM_ADDRESS', 'hello@example.com'),
            'name' => env('MAIL_FROM_NAME', 'Example'),
        ],
    ],
],
```

Add to `.env`:
```env
MAIL_USERNAME=admin@yourdomain.com
```

---

## API Integration (Optional)

Create a controller to trigger backups via API.

**File: `app/Http/Controllers/API/BackupController.php`**

```php
<?php

namespace App\Http\Controllers\API;

use App\Jobs\CreateBackup;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Artisan;
use Illuminate\Support\Facades\Storage;

class BackupController extends Controller
{
    private $disk;
    private $backupName;
    public function __construct()
    {
        $this->disk = Storage::disk(config('backup.backup.destination.disks')[0]);
        $this->backupName = config('backup.backup.name');
    }
    public function createBackup(Request $request)
    {
        $request->validate([
            'flag' => 'required|string|in:full,db,files',
        ]);
        try {
            $flag = $request->input('flag');
            if ($flag === 'db') {
                Artisan::call('backup:run', ['--only-db' => true]);
            }
            if ($flag === 'files') {
                Artisan::call('backup:run', ['--only-files' => true]);
            }
            if ($flag === 'full') {
                Artisan::call('backup:run');
            }
            // CreateBackup::dispatch($flag);
            return response([
                'message' => 'Backup process started.'
            ], 202);
        } catch (\Exception $e) {
            throw new \Exception($e->getMessage());
        }
    }

    public function backUpList()
    {
        try {
            $files = $this->disk->files($this->backupName);
            $backups = collect($files)->map(function ($file) {
                return [
                    'name' => basename($file),
                    'size' => $this->disk->size($file),
                    'date' => $this->disk->lastModified($file),
                    'size_human' => $this->formatBytes($this->disk->size($file)),
                    'date_human' => date('Y-m-d H:i:s', $this->disk->lastModified($file)),
                ];
            })->sortByDesc('date')->values();

            return response([
                'backups' => $backups,
                'total' => $backups->count()
            ], 200);
        } catch (\Exception $e) {
            throw new \Exception($e->getMessage());
        }
    }

    public function downloadBackup($filename)
    {
        try {
            $path = $this->backupName . '/' . $filename;
            if (!$this->disk->exists($path)) {
                return response([
                    'message' => 'Backup file not found.'
                ], 404);
            }
            return $this->disk->download($path);
        } catch (\Exception $e) {
            throw new \Exception($e->getMessage());
        }
    }

    public function deleteBackup($filename)
    {
        try {
            $path = $this->backupName . '/' . $filename;
            if (!$this->disk->exists($path)) {
                return response([
                    'message' => 'Backup file not found.'
                ], 404);
            }
            $this->disk->delete($path);

            return response([
                'message' => 'Backup deleted successfully.'
            ], 200);
        } catch (\Exception $e) {
            throw new \Exception($e->getMessage());
        }
    }

    private function formatBytes($bytes, $precision = 2)
    {
        $units = ['B', 'KB', 'MB', 'GB', 'TB'];
        $bytes = max($bytes, 0);
        $pow = floor(($bytes ? log($bytes) : 0) / log(1024));
        $pow = min($pow, count($units) - 1);
        $bytes /= pow(1024, $pow);
        return round($bytes, $precision) . ' ' . $units[$pow];
    }
}

```

**File: `routes/api.php`**

Add these routes inside the authenticated middleware:

```php
Route::middleware(['auth:sanctum'])->group(function () {
    // ... existing routes
    
    // Backup routes
    Route::prefix('backups')->group(function () {
        Route::post('/create', [BackupController::class, 'createBackup']);
        Route::get('/list', [BackupController::class, 'backUpList']);
        Route::get('/download/{filename}', [BackupController::class, 'downloadBackup']);
        Route::delete('/delete/{filename}', [BackupController::class, 'deleteBackup']);
    });
});
```

### Running the Scheduler

For local development, run:
```bash
php artisan make:job CreateBackup
```

Then implement the job to call the backup command.
```php
<?php
namespace App\Jobs;

use Illuminate\Support\Facades\Artisan;
use Illuminate\Foundation\Queue\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;

class CreateBackup implements ShouldQueue
{
    use Queueable;

    public $flag;

    public function __construct($flag)
    {
        $this->flag = $flag;
    }

    public function handle()
    {
        if ($this->flag === 'db') {
            Artisan::call('backup:run', ['--only-db' => true]);
        } elseif ($this->flag === 'files') {
            Artisan::call('backup:run', ['--only-files' => true]);
        } else {
            Artisan::call('backup:run');
        }
    }
}
```

---

## Summary

Spatie Laravel Backup provides:
- ✅ Automated database backups
- ✅ File system backups
- ✅ Automatic cleanup of old backups
- ✅ Email notifications
- ✅ Health monitoring
- ✅ Easy API integration

The package is production-ready and follows Laravel best practices for backup management.
