# Spatie Laravel Backup Integration

This guide provides step-by-step instructions for integrating Spatie Laravel Backup into your Laravel application for automated database and file backups.

## Overview
Spatie Laravel Backup is a powerful package that allows you to:
- Backup your database (MySQL, PostgreSQL, SQLite, etc.)
- Backup your application files
- Store backups on multiple storage destinations (local, S3, Dropbox, etc.)
- Monitor backup health
- Clean up old backups automatically
- Receive notifications about backup status

---

## Installation

### 0. Docker Environment Setup (IMPORTANT)

If you're using Docker, you need to install the database dump utilities in your container.

**File: `Dockerfile`**

Add `mariadb-client` (for MySQL/MariaDB) to your package installation:

```dockerfile
# Install required Linux libraries
RUN apt-get update -y && apt-get install -y \
    libicu-dev \
    libmariadb-dev \
    unzip zip \
    zlib1g-dev \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libjpeg62-turbo-dev \
    libzip-dev \
    mariadb-client
```

**Rebuild your Docker image:**
```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

> **Note:** For PostgreSQL, install `postgresql-client` instead of `mariadb-client`

### 1. Install the Package

Install Spatie Laravel Backup via Composer:

**For Docker:**
```bash
composer require spatie/laravel-backup
```

### 2. Publish Configuration File

Publish the configuration file to customize backup settings:

**For Docker:**
```bash
php artisan vendor:publish --provider="Spatie\Backup\BackupServiceProvider"
```

This will create a `config/backup.php` file.

### 3. Configure Filesystem Disks

The package uses Laravel's filesystem to store backups. Update your `config/filesystems.php` if needed.

**File: `config/filesystems.php`**

Add a backup disk (optional, you can use existing disks):

```php
'disks' => [
    // ... existing disks
    
    'backup' => [
        'driver' => 'local',
        'root' => storage_path('app/backups'),
    ],
],
```

---

## Configuration

### Basic Configuration

**File: `config/backup.php`**

Key configuration sections:

#### 1. Backup Name
```php
'backup' => [
    'name' => env('APP_NAME', 'laravel-backup'),
```

#### 2. Database Selection
```php
'source' => [
    'databases' => [
        'sqlite', // or 'mysql', 'pgsql', etc.
    ],
```

#### 3. Files to Include
```php
    'files' => [
        'include' => [
            base_path(), // Entire application
        ],
        'exclude' => [
            base_path('vendor'),
            base_path('node_modules'),
            base_path('storage/app/backups'),
        ],
    ],
],
```

#### 4. Storage Destination
```php
'destination' => [
    'disks' => [
        'local', // Can add 's3', 'dropbox', etc.
    ],
],
```

#### 5. Cleanup Settings
```php
'cleanup' => [
    'strategy' => \Spatie\Backup\Tasks\Cleanup\Strategies\DefaultStrategy::class,
    'default_strategy' => [
        'keep_all_backups_for_days' => 7,
        'keep_daily_backups_for_days' => 16,
        'keep_weekly_backups_for_weeks' => 8,
        'keep_monthly_backups_for_months' => 4,
        'keep_yearly_backups_for_years' => 2,
        'delete_oldest_backups_when_using_more_megabytes_than' => 5000,
    ],
],
```

---

## Environment Variables

Add these to your `.env` file:

```env
# Backup Configuration
BACKUP_DISK=local
BACKUP_NAME="${APP_NAME}"

# Optional: For cloud storage
# AWS_ACCESS_KEY_ID=your-key
# AWS_SECRET_ACCESS_KEY=your-secret
# AWS_DEFAULT_REGION=us-east-1
# AWS_BUCKET=your-bucket
```

---

## Usage

### Manual Backup Commands

#### Run a Full Backup
**Docker:**
```bash
php artisan backup:run
```

#### Backup Only Database
**Docker:**
```bash
php artisan backup:run --only-db
```

#### Backup Only Files
**Docker:**
```bash
php artisan backup:run --only-files
```

#### List All Backups
**Docker:**
```bash
php artisan backup:list
```

#### Clean Old Backups
**Docker:**
```bash
php artisan backup:clean
```

#### Monitor Backup Health
**Docker:**
```bash
php artisan backup:monitor
```

---

## Automated Backups with Task Scheduler

Schedule automatic backups using Laravel's task scheduler.

**File: `app/Console/Kernel.php` or `routes/console.php` (Laravel 11+)**

For Laravel 11+, add to `routes/console.php`:

```php
use Illuminate\Support\Facades\Schedule;

Schedule::command('backup:clean')->daily()->at('01:00');
Schedule::command('backup:run')->daily()->at('02:00');
Schedule::command('backup:monitor')->daily()->at('03:00');
```

For older Laravel versions, update `app/Console/Kernel.php`:

```php
protected function schedule(Schedule $schedule)
{
    $schedule->command('backup:clean')->daily()->at('01:00');
    $schedule->command('backup:run')->daily()->at('02:00');
    $schedule->command('backup:monitor')->daily()->at('03:00');
}
```

### Running the Scheduler

For local development, run:
```bash
php artisan schedule:work
```

For production, add to crontab:
```
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

---

## Notifications

### Email Notifications

Configure email notifications in `config/backup.php`:

```php
'notifications' => [
    'notifications' => [
        \Spatie\Backup\Notifications\Notifications\BackupHasFailedNotification::class => ['mail'],
        \Spatie\Backup\Notifications\Notifications\UnhealthyBackupWasFoundNotification::class => ['mail'],
        \Spatie\Backup\Notifications\Notifications\CleanupHasFailedNotification::class => ['mail'],
        \Spatie\Backup\Notifications\Notifications\BackupWasSuccessfulNotification::class => ['mail'],
        \Spatie\Backup\Notifications\Notifications\HealthyBackupWasFoundNotification::class => ['mail'],
        \Spatie\Backup\Notifications\Notifications\CleanupWasSuccessfulNotification::class => ['mail'],
    ],

    'notifiable' => \Spatie\Backup\Notifications\Notifiable::class,

    'mail' => [
        'to' => env('BACKUP_MAIL_TO', 'your-email@example.com'),
        'from' => [
            'address' => env('MAIL_FROM_ADDRESS', 'hello@example.com'),
            'name' => env('MAIL_FROM_NAME', 'Example'),
        ],
    ],
],
```

Add to `.env`:
```env
BACKUP_MAIL_TO=admin@yourdomain.com
```

### Slack Notifications

Install Slack notification channel:
```bash
composer require laravel/slack-notification-channel
```

Update `.env`:
```env
BACKUP_SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK
```

Update `config/backup.php`:
```php
'notifications' => [
    \Spatie\Backup\Notifications\Notifications\BackupWasSuccessfulNotification::class => ['slack'],
    // ... other notifications
],

'slack' => [
    'webhook_url' => env('BACKUP_SLACK_WEBHOOK_URL'),
    'channel' => null,
    'username' => null,
    'icon' => null,
],
```

---

## Cloud Storage Integration

### AWS S3 Storage

1. Install AWS SDK:
```bash
composer require league/flysystem-aws-s3-v3 "^3.0"
```

2. Add to `.env`:
```env
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=your-backup-bucket
AWS_USE_PATH_STYLE_ENDPOINT=false
```

3. Configure filesystem disk in `config/filesystems.php`:
```php
's3-backups' => [
    'driver' => 's3',
    'key' => env('AWS_ACCESS_KEY_ID'),
    'secret' => env('AWS_SECRET_ACCESS_KEY'),
    'region' => env('AWS_DEFAULT_REGION'),
    'bucket' => env('AWS_BUCKET'),
],
```

4. Update `config/backup.php`:
```php
'destination' => [
    'disks' => [
        'local',
        's3-backups',
    ],
],
```

### Dropbox Storage

1. Install Dropbox adapter:
```bash
composer require spatie/flysystem-dropbox
```

2. Configure in `config/filesystems.php`:
```php
'dropbox' => [
    'driver' => 'dropbox',
    'authorization_token' => env('DROPBOX_AUTH_TOKEN'),
],
```

3. Add to `config/backup.php` destination disks.

---

## API Integration (Optional)

Create a controller to trigger backups via API.

**File: `app/Http/Controllers/API/BackupController.php`**

```php
<?php

namespace App\Http\Controllers\API;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Artisan;
use Illuminate\Support\Facades\Storage;

class BackupController extends Controller
{
    public function createBackup(Request $request)
    {
        try {
            Artisan::call('backup:run', [
                '--only-db' => $request->boolean('only_db', false),
            ]);
            
            return response()->json([
                'message' => 'Backup created successfully.',
                'output' => Artisan::output()
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'message' => 'Backup failed.',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    public function listBackups()
    {
        try {
            $disk = Storage::disk(config('backup.backup.destination.disks')[0]);
            $backupName = config('backup.backup.name');
            
            $files = $disk->files($backupName);
            $backups = collect($files)->map(function ($file) use ($disk) {
                return [
                    'name' => basename($file),
                    'size' => $disk->size($file),
                    'date' => $disk->lastModified($file),
                    'size_human' => $this->formatBytes($disk->size($file)),
                    'date_human' => date('Y-m-d H:i:s', $disk->lastModified($file)),
                ];
            })->sortByDesc('date')->values();

            return response()->json([
                'backups' => $backups,
                'total' => $backups->count()
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'message' => 'Failed to list backups.',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    public function downloadBackup($filename)
    {
        try {
            $disk = Storage::disk(config('backup.backup.destination.disks')[0]);
            $backupName = config('backup.backup.name');
            $path = $backupName . '/' . $filename;

            if (!$disk->exists($path)) {
                return response()->json([
                    'message' => 'Backup file not found.'
                ], 404);
            }

            return $disk->download($path);
        } catch (\Exception $e) {
            return response()->json([
                'message' => 'Download failed.',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    public function deleteBackup($filename)
    {
        try {
            $disk = Storage::disk(config('backup.backup.destination.disks')[0]);
            $backupName = config('backup.backup.name');
            $path = $backupName . '/' . $filename;

            if (!$disk->exists($path)) {
                return response()->json([
                    'message' => 'Backup file not found.'
                ], 404);
            }

            $disk->delete($path);

            return response()->json([
                'message' => 'Backup deleted successfully.'
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'message' => 'Delete failed.',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    private function formatBytes($bytes, $precision = 2)
    {
        $units = ['B', 'KB', 'MB', 'GB', 'TB'];
        $bytes = max($bytes, 0);
        $pow = floor(($bytes ? log($bytes) : 0) / log(1024));
        $pow = min($pow, count($units) - 1);
        $bytes /= pow(1024, $pow);
        return round($bytes, $precision) . ' ' . $units[$pow];
    }
}
```

**File: `routes/api.php`**

Add these routes inside the authenticated middleware:

```php
Route::middleware(['auth:sanctum'])->group(function () {
    // ... existing routes
    
    // Backup routes
    Route::prefix('backups')->group(function () {
        Route::post('/create', [BackupController::class, 'createBackup']);
        Route::get('/list', [BackupController::class, 'listBackups']);
        Route::get('/download/{filename}', [BackupController::class, 'downloadBackup']);
        Route::delete('/delete/{filename}', [BackupController::class, 'deleteBackup']);
    });
});
```

---

## Testing

### Test Backup Creation
```bash
php artisan backup:run
```

### Verify Backup Files
Check `storage/app/Laravel` (or your configured disk):
```bash
ls -lh storage/app/Laravel/
```

### Test Cleanup
```bash
php artisan backup:clean
```

### Test Monitoring
```bash
php artisan backup:monitor
```

---

## Security Best Practices

1. **Exclude Sensitive Directories**: Ensure vendor, node_modules, and previous backups are excluded
2. **Encrypt Backups**: For cloud storage, enable encryption
3. **Secure API Endpoints**: Add proper authentication and authorization
4. **Limit Access**: Restrict backup download/delete to admin users only
5. **Regular Testing**: Periodically test backup restoration
6. **Off-site Storage**: Always store backups in a different location than your application

---

## Backup Restoration

To restore a backup:

1. Download the backup file from your storage
2. Extract the ZIP file
3. Restore database:
```bash
# For SQLite
cp backup/db-dumps/sqlite-database.sql database/database.sqlite

# For MySQL
mysql -u username -p database_name < backup/db-dumps/mysql-database.sql
```
4. Restore files if needed

---

## Troubleshooting

### Common Issues:

1. **Permission Denied**:
```bash
chmod -R 775 storage/app/backups
```

2. **Timeout on Large Backups**:
Update `config/backup.php`:
```php
'timeout' => 3600, // 1 hour
```

3. **Memory Limit**:
Increase PHP memory limit in `.env`:
```env
MEMORY_LIMIT=512M
```

4. **Queue Jobs**:
For large backups, run in background:
```bash
php artisan backup:run &
```

---

## Monitoring Dashboard (Optional)

Create a simple monitoring view in your admin panel:

```php
// In your admin controller
public function backupStatus()
{
    $backups = collect(Storage::disk('local')->files('Laravel'))
        ->map(function ($file) {
            return [
                'name' => basename($file),
                'size' => Storage::disk('local')->size($file),
                'modified' => Storage::disk('local')->lastModified($file),
            ];
        })
        ->sortByDesc('modified');

    return view('admin.backups', compact('backups'));
}
```

---

## Summary

Spatie Laravel Backup provides:
- ✅ Automated database backups
- ✅ File system backups
- ✅ Multiple storage destinations
- ✅ Automatic cleanup of old backups
- ✅ Email/Slack notifications
- ✅ Health monitoring
- ✅ Easy API integration
- ✅ Cloud storage support (S3, Dropbox, etc.)

The package is production-ready and follows Laravel best practices for backup management.
