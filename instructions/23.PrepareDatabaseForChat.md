# Prepare Database for Chat System

This guide sets up the database structure for a chat system with support for user chats, group chats, and system notifications. It includes migrations for three tables (chats, chat_messages, chat_members), their relationships, Eloquent models, and seeders.

---

## Database Migrations

### 1. Create Chats Table

**File:** `database/migrations/2026_01_20_163104_create_chats_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('chats', function (Blueprint $table) {
            $table->id();
            $table->string('name', 250)->nullable();
            $table->string('photo')->nullable();
            $table->enum('type', ['user', 'group']);
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('chats');
    }
};
```

**Table Structure:**
- `id` - Primary key
- `name` - Chat name (max 250 characters) - nullable for 1-on-1 chats
- `type` - Chat type: `user` (1-on-1), `group` (multiple users), `system` (notifications)
- `timestamps` - Created at and updated at

---

### 2. Create Chat Messages Table

**File:** `database/migrations/2026_01_20_163356_create_chat_messages_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('chat_messages', function (Blueprint $table) {
            $table->id();
            $table->text('content');
            $table->enum('type', ['text', 'image', 'video', 'file']);
            $table->unsignedBigInteger('chat_id')->index('chat_id');
            $table->unsignedBigInteger('user_id')->index('user_id');
            $table->timestamp('seen_at')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('chat_messages');
    }
};
```

**Table Structure:**
- `id` - Primary key
- `content` - Message content (text field)
- `type` - Message type: `text`, `image`, `video`, `file`
- `chat_id` - Foreign key to chats table (indexed)
- `user_id` - Foreign key to users table (indexed)
- `timestamps` - Created at and updated at

---

### 3. Create Chat Members Table

**File:** `database/migrations/2026_01_20_163627_create_chat_members_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('chat_members', function (Blueprint $table) {
            $table->id();
            $table->enum('role', ['admin', 'member']);
            $table->unsignedBigInteger('chat_id')->index('chat_id');
            $table->unsignedBigInteger('user_id')->index('user_id');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('chat_members');
    }
};
```

**Table Structure:**
- `id` - Primary key
- `role` - Member role: `admin` (can manage chat), `member` (regular participant)
- `chat_id` - Foreign key to chats table (indexed)
- `user_id` - Foreign key to users table (indexed)
- `timestamps` - Created at and updated at

---

### 4. Add Foreign Keys to Chat Messages

**File:** `database/migrations/2026_01_20_165249_add_keys_to_chat_messages_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('chat_messages', function (Blueprint $table) {
            $table->foreign(['chat_id'], 'chat_message1')->references(['id'])->on('chats')->onDelete('restrict')->onUpdate('restrict');
            $table->foreign(['user_id'], 'chat_message2')->references(['id'])->on('users')->onDelete('restrict')->onUpdate('restrict');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('chat_messages', function (Blueprint $table) {
            $table->dropForeign('chat_message1');
            $table->dropForeign('chat_message2');
        });
    }
};
```

**Foreign Key Constraints:**
- `chat_message1` - References `chats.id` with RESTRICT on delete and update
- `chat_message2` - References `users.id` with RESTRICT on delete and update

**RESTRICT behavior:** Prevents deletion or update of parent records if child records exist.

---

### 5. Add Foreign Keys to Chat Members

**File:** `database/migrations/2026_01_20_165630_add_keys_to_chat_members_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('chat_members', function (Blueprint $table) {
            $table->foreign(['chat_id'], 'chat_member1')->references(['id'])->on('chats')->onDelete('restrict')->onUpdate('restrict');
            $table->foreign(['user_id'], 'chat_member2')->references(['id'])->on('users')->onDelete('restrict')->onUpdate('restrict');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('chat_members', function (Blueprint $table) {
            $table->dropForeign('chat_member1');
            $table->dropForeign('chat_member2');
        });
    }
};
```

**Foreign Key Constraints:**
- `chat_member1` - References `chats.id` with RESTRICT on delete and update
- `chat_member2` - References `users.id` with RESTRICT on delete and update

---

## Eloquent Models

### 1. Chat Model

**File:** `app/Models/Chat.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Chat extends Model
{
    use HasFactory;
    protected $table = 'chats';
    protected $primaryKey = 'id';
    protected $fillable = [
        'name',
        'photo'
        'type',
    ];

    public function messages()
    {
        return $this->hasMany(ChatMessage::class);
    }

    public function members()
    {
        return $this->hasMany(ChatMember::class);
    }

    public function users()
    {
        /**
         * Key mapping:
         * - User::class: The related model (User).
         * - ChatMember::class: The intermediate model (ChatMember).
         * - 'chat_id': Foreign key on the ChatMember table referencing the Chat.
         * - 'id': Local key on the Chat model.
         * - 'id': Local key on the User model.
         * - 'user_id': Foreign key on the ChatMember table referencing the User.
         */
        return $this->hasManyThrough(User::class, ChatMember::class, 'chat_id', 'id', 'id', 'user_id');
    }
}
```

**Relationships:**
- `messages()` - Get all messages in the chat
- `members()` - Get all chat member records
- `users()` - Get all users participating in the chat via `hasManyThrough`

---

### 2. ChatMessage Model

**File:** `app/Models/ChatMessage.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class ChatMessage extends Model
{
    use HasFactory;
    protected $table = 'chat_messages';
    protected $primaryKey = 'id';
    protected $casts = [
        'seen_at' => 'datetime',
    ];
    protected $fillable = [
        'content',
        'type',
        'chat_id',
        'user_id',
        'seen_at'
    ];

    public function chat()
    {
        return $this->belongsTo(Chat::class);
    }

    public function user()
    {
        return $this->belongsTo(User::class);
    }
}
```

**Relationships:**
- `chat()` - Get the chat this message belongs to
- `user()` - Get the user who sent this message

---

### 3. ChatMember Model

**File:** `app/Models/ChatMember.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class ChatMember extends Model
{
    use HasFactory;
    protected $table = 'chat_members';
    protected $primaryKey = 'id';
    protected $fillable = [
        'role',
        'chat_id',
        'user_id',
    ];

    public function chat()
    {
        return $this->belongsTo(Chat::class);
    }

    public function user()
    {
        return $this->belongsTo(User::class);
    }
}
```

**Relationships:**
- `chat()` - Get the chat this member belongs to
- `user()` - Get the user for this member

---

## Database Seeders

### 1. User Seeder

**File:** `database/seeders/UserSeeder.php`

```php
<?php

namespace Database\Seeders;

use App\Models\User;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Hash;

class UserSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // Create admin user
        User::create([
            'name' => 'Admin User',
            'email' => 'admin@example.com',
            'password' => Hash::make('password'),
            'email_verified_at' => now(),
            'level' => 'admin',
        ]);
        // Create additional random users
        User::factory(20)->create();
        User::factory(10)->unverified()->create();
    }
}
```

**Seeds:**
- 1 admin user (email: `admin@example.com`, password: `password`)
- 20 verified users (via factory)
- 10 unverified users (via factory)

---

### 2. Database Seeder

**File:** `database/seeders/DatabaseSeeder.php`

```php
<?php

namespace Database\Seeders;

use App\Models\User;
use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    use WithoutModelEvents;

    /**
     * Seed the application's database.
     */
    public function run(): void
    {
        $this->call([
            UserSeeder::class,
        ]);
    }
}
```

---

## Running Migrations and Seeders

### Run Migrations

```bash
php artisan migrate
```

### Run Migrations from Fresh

```bash
php artisan migrate:fresh
```

### Run Seeders

```bash
php artisan db:seed
```

### Run Specific Seeder

```bash
php artisan db:seed --class=UserSeeder
```

### Migrate and Seed Together

```bash
php artisan migrate:fresh --seed
```

---

## Database Relationships Summary

### Chat
- **Has many** ChatMessages
- **Has many** ChatMembers
- **Has many through** Users (via ChatMembers)

### ChatMessage
- **Belongs to** Chat
- **Belongs to** User

### ChatMember
- **Belongs to** Chat
- **Belongs to** User

### User
- **Has many** ChatMessages
- **Has many** ChatMembers
- **Belongs to many** Chats (via ChatMembers)

---

## Usage Examples

### Create a Chat

```php
$chat = Chat::create([
    'name' => 'General Discussion',
    'type' => 'group',
]);
```

### Add Members to Chat

```php
ChatMember::create([
    'chat_id' => $chat->id,
    'user_id' => 1,
    'role' => 'admin',
]);

ChatMember::create([
    'chat_id' => $chat->id,
    'user_id' => 2,
    'role' => 'member',
]);
```

### Send a Message

```php
ChatMessage::create([
    'chat_id' => $chat->id,
    'user_id' => auth()->id(),
    'content' => 'Hello everyone!',
    'type' => 'text',
]);
```

### Get All Messages in a Chat

```php
$messages = Chat::find(1)->messages;
```

### Get All Users in a Chat

```php
$users = Chat::find(1)->users;
```

### Get All Chats for a User

```php
$userChats = User::find(1)->chatMembers()->with('chat')->get();
```

---

## Notes

- Foreign keys use **RESTRICT** to prevent accidental deletion of chats or users with existing messages/members
- Chat types: `user` (1-on-1), `group` (multiple users), `system` (notifications)
- Message types: `text`, `image`, `video`, `file`
- Member roles: `admin` (can manage), `member` (regular participant)
- All tables use `unsignedBigInteger` for foreign keys to match Laravel's default `id()` type
- Indexes are created on foreign key columns for better query performance
