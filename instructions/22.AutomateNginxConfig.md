# Automated Nginx Deployment with phpMyAdmin Integration

## Overviewincludes:
- Automated Nginx configuration deployment via GitHub Actions
- phpMyAdmin service integration
- Enhanced CI/CD pipeline with Nginx management

## Changes Summary

### 1. New Nginx Configuration File
### 2. Updated GitHub Actions Workflow with Nginx Automation
### 3. Added phpMyAdmin Service to Production Docker Compose

---

## Step 1: Create Nginx Configuration File

**File Path:** `example.cloud` (root directory)

**Purpose:** Nginx configuration file that will be automatically deployed to VPS

```nginx
# ===== NGINX CONFIGURATION START =====

# Main HTTPS server
server {
    listen 443 ssl http2;
    server_name example.cloud www.example.cloud;

    # SSL files
    ssl_certificate /etc/letsencrypt/live/example.cloud/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.cloud/privkey.pem;

    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
    }

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
    }

    # phpMyAdmin at /phpmyadmin/
    location = /phpmyadmin { return 301 /phpmyadmin/; }
    location /phpmyadmin/ {
        proxy_pass http://localhost:9000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header HTTPS on;
        proxy_set_header X-Forwarded-Ssl on;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header X-Forwarded-Host $host;
        proxy_cookie_path / /phpmyadmin/;
        proxy_redirect     default;
        proxy_buffering    off;
        client_max_body_size 100M;
    }
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name example.cloud www.example.cloud;
    return 301 https://$host$request_uri;
}

# Block direct HTTP/IP access
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;
    return 444; # or 403;
}

# ===== NGINX CONFIGURATION END =====
```

---

## Step 2: Updated GitHub Actions Workflow

**File Path:** `.github/workflows/deploy.yml`

**Complete File Content:**

```yaml
name: CI/CD pipeline
env:
  NGINX_CONFIG: example.cloud
on:
  push:
    branches: [week5]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Copy files to VPS via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "."
          target: "~/example.cloud"
      - name: Deploy Backend and Frontend on VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # Deploy Backend
            cd ~/example.cloud
            docker compose -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.prod.yml up -d --build

            # Deploy Frontend
            cd ~/example.cloud/frontend
            docker compose -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.prod.yml up -d --build

            # Install nginx if not installed
            sudo apt update && sudo apt install -y nginx

            # Overwrite nginx config file
            sudo cp ~/example.cloud/${{ env.NGINX_CONFIG }} /etc/nginx/sites-available/${{ env.NGINX_CONFIG }}
            sudo ln -sf /etc/nginx/sites-available/${{ env.NGINX_CONFIG }} /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default

            # Test and reload nginx
            sudo nginx -t && sudo systemctl enable nginx && sudo systemctl start nginx && sudo systemctl reload nginx
```

### Key Changes:

**Added Environment Variable:**
```yaml
env:
  NGINX_CONFIG: example.cloud
```
- Defines the nginx config filename for reusability

**New Nginx Automation Steps:**
1. **Install Nginx** (if not already installed)
2. **Copy Configuration** from repository to nginx sites-available
3. **Create Symlink** to sites-enabled
4. **Remove Default Config** to prevent conflicts
5. **Test & Reload** nginx configuration

---

## Step 3: Updated Production Docker Compose

**File Path:** `docker-compose.prod.yml`

**Complete File Content:**

```yaml
services:
  app:
    build: .
    image: example.cloud:latest
    container_name: example.cloud-container
    volumes:
      - ./:/var/www/html
      - node:/var/www/html/node_modules
      - laravel:/var/www/html/vendor
    command: sh /var/www/html/production.sh
    ports:
      - 8000:80
    depends_on:
      - mysql
    environment:
      # Application Settings
      APP_NAME: example
      APP_ENV: production
      APP_DEBUG: false
      APP_URL: https://example.cloud
      APP_FRONTEND_URL: https://example.cloud
      APP_EMAIL_VERIFICATION_URL: "https://example.cloud/email/verify"
      APP_PASSWORD_RESET_URL: "https://example.cloud/password/reset"

      # Google OAuth (CRITICAL)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REDIRECT_URL: "https://example.cloud/api/auth/google/callback"

      # Database Configuration
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
  mysql:
    image: mariadb:10.11.13
    container_name: mysql-example.cloud-container
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      TZ: UTC
    command: --sql-mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"
    volumes:
      - mysql:/var/lib/mysql
    ports:
      - 3306:3306
  phpmyadmin:
    image: phpmyadmin:5.2.2
    container_name: phpmyadmin-example.cloud-container
    depends_on:
      - mysql
    environment:
      UPLOAD_LIMIT: 50M
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_ABSOLUTE_URI: "https://example.cloud/phpmyadmin/"
    ports:
      - 9000:80
volumes:
  mysql:
    name: example.cloud-mysql
  node:
    name: example.cloud-node
  laravel:
    name: example.cloud-laravel
```

### New phpMyAdmin Service:

```yaml
phpmyadmin:
  image: phpmyadmin:5.2.2
  container_name: phpmyadmin-example.cloud-container
  depends_on:
    - mysql
  environment:
    UPLOAD_LIMIT: 50M
    PMA_HOST: mysql
    PMA_PORT: 3306
    PMA_ABSOLUTE_URI: "https://example.cloud/phpmyadmin/"
  ports:
    - 9000:80
```

**phpMyAdmin Configuration:**
- **Image:** phpMyAdmin 5.2.2
- **Port:** 9000 (mapped to internal port 80)
- **Upload Limit:** 50MB for database imports
- **Absolute URI:** Configured for subpath access at `/phpmyadmin/`
- **Database Connection:** Connects to mysql service

---

## Access URLs After Deployment

| Service | URL | Port |
|---------|-----|------|
| Frontend | https://example.cloud | 3000 (proxied) |
| Backend API | https://example.cloud/api/ | 8000 (proxied) |
| phpMyAdmin | https://example.cloud/phpmyadmin/ | 9000 (proxied) |
| MySQL | Direct connection only | 3306 |

---

## Notes

- The nginx configuration is now version-controlled and automatically deployed
- phpMyAdmin provides web-based database management
- All services are accessible through HTTPS with proper SSL
- The workflow automatically handles nginx installation and configuration updates
- HTTP traffic is automatically redirected to HTTPS
- Direct IP access attempts are blocked for security
